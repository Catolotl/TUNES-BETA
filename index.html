<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tunes</title>
  <style>
    :root {
      --bg: linear-gradient(to bottom, #001414, #000);
      --surface: #232323;
      --card: #181818;
      --hover: #282828;
      --text: #fff;
      --text-secondary: #b3b3b3;
      --accent: #1DB954;
      --border: #000;
      --theme-color: #1DB954;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      height: 100vh;
      overflow: hidden;
      transition: background 0.8s ease;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 70px;
      padding: 0 24px;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      z-index: 20;
    }
    header h2 {
      margin: 0;
      font-size: 1.4em;
      font-weight: 600;
      background: linear-gradient(90deg, #1DB954, #1ed760);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-center {
      display: flex;
      gap: 8px;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    .header-center .nav-item {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      background: rgba(255, 255, 255, 0.1);
      transition: background 0.2s ease;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .header-center .nav-item:hover {
      background: rgba(255, 255, 255, 0.15);
    }
    .header-center .nav-item.active {
      background: rgba(29, 185, 84, 0.3);
    }
    .header-center .nav-item svg {
      width: 16px;
      height: 16px;
      fill: var(--text);
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    #premium-btn {
      background: var(--theme-color);
      color: #000;
      padding: 8px 18px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9em;
      transition: transform 0.2s;
    }
    #premium-btn:hover {
      transform: scale(1.05);
    }
    #profile-btn {
      width: 36px;
      height: 36px;
      background: #333;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-weight: bold;
      overflow: hidden;
    }
    #profile-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #main-wrapper {
      display: flex;
      width: 100%;
      height: 100vh;
      padding-top: 70px;
    }
    #sidebar {
      width: 280px;
      background: var(--surface);
      overflow-y: auto;
      border-right: 1px solid var(--border);
      padding: 20px 0;
    }
    .playlists-header {
      padding: 16px 16px 8px;
      font-size: 0.85em;
      color: var(--text-secondary);
      letter-spacing: 0.5px;
      font-weight: 600;
      text-transform: uppercase;
    }
    .nav-item, .playlist-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      cursor: pointer;
      gap: 12px;
      transition: 0.2s;
    }
    .nav-item:hover, .playlist-item:hover {
      background: var(--hover);
    }
    .playlist-cover {
      width: 42px;
      height: 42px;
      object-fit: cover;
      border-radius: 4px;
    }
    #content {
      flex: 1;
      padding: 20px 32px 100px;
      overflow-y: auto;
    }
    .section {
      margin-bottom: 36px;
    }
    .section h3 {
      margin: 0 0 16px;
      font-size: 1.5em;
      font-weight: 700;
    }
    #welcome {
      font-size: 2em;
      margin-bottom: 24px;
      font-weight: 700;
    }
    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 20px;
    }
    .grid-card {
      background: var(--card);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .grid-card:hover {
      background: var(--hover);
    }
    .grid-cover {
      width: 100%;
      aspect-ratio: 1;
      object-fit: cover;
      border-radius: 4px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      margin-bottom: 12px;
    }
    .grid-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .grid-artist {
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .song-card {
      background: transparent;
      padding: 12px 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: 0.2s;
      margin-bottom: 8px;
    }
    .song-card:hover {
      background: var(--hover);
    }
    .cover {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 4px;
    }
    #player {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 100%;
      background: rgba(24, 24, 24, 0.95);
      backdrop-filter: blur(20px);
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      display: none;
      z-index: 30;
    }
    #player-content {
      display: flex;
      align-items: center;
      gap: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    #player-info {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }
    #player-cover {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 4px;
    }
    #controls {
      display: flex;
      align-items: center;
      gap: 16px;
      flex: 2;
      flex-direction: column;
    }
    #control-buttons {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    #control-buttons button {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 1.2em;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      transition: 0.2s;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #play-pause-btn {
      font-size: 1.8em;
      width: 40px;
      height: 40px;
      background: var(--accent);
      color: #000;
    }
    #control-buttons button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    #play-pause-btn:hover {
      background: #1ed760;
    }
    #progress-container {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    #progress-bar {
      flex: 1;
      -webkit-appearance: none;
      appearance: none;
      height: 4px;
      background: #404040;
      border-radius: 2px;
      cursor: pointer;
    }
    #progress-bar::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: var(--accent);
      border-radius: 50%;
      cursor: pointer;
    }
    .time-text {
      font-size: 0.75em;
      color: var(--text-secondary);
      min-width: 40px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      background: var(--card);
      border: none;
      border-radius: 8px;
      color: var(--text);
      margin-bottom: 16px;
      font-size: 1em;
    }
    input:focus {
      outline: none;
      box-shadow: 0 0 0 2px var(--accent);
    }
    button {
      background: var(--hover);
      color: var(--text);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: 0.2s;
      font-weight: 500;
    }
    button:hover {
      background: #333;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-overlay.active {
      display: flex;
    }
    .modal-box {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      width: 90%;
      max-width: 400px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.6);
    }
    .modal-box h3 {
      margin: 0 0 16px;
      font-size: 1.3em;
    }
    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }
    .modal-buttons .primary {
      background: var(--accent);
      color: #000;
    }
    .heart-btn {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      margin-left: 8px;
    }
    .heart-btn:hover {
      opacity: 1;
    }
    .heart-btn.liked {
      color: #1DB954;
      opacity: 1;
    }
    #youtube-player {
      display: none;
      width: 0;
      height: 0;
    }
    .skeleton {
      height: 72px;
      background: linear-gradient(90deg, #202020, #2a2a2a, #202020);
      background-size: 200% 100%;
      animation: loading 1.4s infinite;
      border-radius: 8px;
      margin-bottom: 8px;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
  </style>
</head>
<body>
  <div id="main-wrapper">
    <header>
      <h2>Tunes</h2>
      <div class="header-center">
        <div id="home-nav" class="nav-item active">
          <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
          <span>Home</span>
        </div>
        <div id="search-nav" class="nav-item">
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
          <span>Search</span>
        </div>
      </div>
      <div class="header-right">
        <div id="premium-btn">Premium</div>
        <div id="profile-btn">U</div>
      </div>
    </header>

    <div id="sidebar">
      <div class="playlists-header">Your Library</div>
    </div>

    <div id="content">
      <div id="home-page">
        <div id="welcome">Good evening</div>
        <div class="section">
          <h3>Recently Played</h3>
          <div id="recently-played"></div>
        </div>
        <div class="section">
          <h3>Your Playlists</h3>
          <div id="your-playlists"></div>
        </div>
        <div class="section">
          <h3>Discover</h3>
          <input type="text" id="recommend-input" placeholder="Search for songs to get recommendations...">
          <div id="ai-recommendations"></div>
        </div>
      </div>

      <div id="search-page" style="display:none;">
        <input type="text" id="search" placeholder="Search for songs, artists, albums...">
        <div id="results"></div>
      </div>
    </div>
  </div>

  <div id="player">
    <div id="player-content">
      <div id="player-info">
        <img id="player-cover" src="https://via.placeholder.com/56" alt="cover">
        <div style="flex:1; min-width:0;">
          <div id="player-title" style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">Nothing playing</div>
          <div id="player-artist" style="font-size:0.85em; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">—</div>
        </div>
      </div>
      <div id="controls">
        <div id="control-buttons">
          <button id="prev-btn">⏮</button>
          <button id="play-pause-btn">▶</button>
          <button id="next-btn">⏭</button>
        </div>
        <div id="progress-container">
          <span class="time-text" id="current-time">0:00</span>
          <input type="range" id="progress-bar" value="0" min="0" max="100">
          <span class="time-text" id="duration-time">0:00</span>
        </div>
      </div>
      <div style="flex:1;"></div>
    </div>
  </div>

  <div id="input-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="input-modal-title">Input</h3>
      <input type="text" id="input-modal-input">
      <div class="modal-buttons">
        <button id="input-modal-cancel">Cancel</button>
        <button id="input-modal-ok" class="primary">OK</button>
      </div>
    </div>
  </div>

  <div id="alert-modal" class="modal-overlay">
    <div class="modal-box">
      <h3 id="alert-modal-title">Notice</h3>
      <p id="alert-modal-message"></p>
      <div class="modal-buttons">
        <button id="alert-modal-ok" class="primary">OK</button>
      </div>
    </div>
  </div>

  <div id="youtube-player"></div>

  <script async defer src="https://www.youtube.com/iframe_api"></script>
  <script>
    // State
    let userName = localStorage.getItem("userName") || "User";
    let recentlyPlayed = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
    let playlists = JSON.parse(localStorage.getItem("miniPlaylists") || "{}");
    let likedArtists = JSON.parse(localStorage.getItem("likedArtists") || "{}");
    let currentSong = null;
    let currentPlaylist = null;
    let ytPlayer = null;
    let playerReady = false;
    let progressInterval = null;

    // DOM
    const homeNav = document.getElementById('home-nav');
    const searchNav = document.getElementById('search-nav');
    const homePage = document.getElementById('home-page');
    const searchPage = document.getElementById('search-page');
    const searchInput = document.getElementById('search');
    const results = document.getElementById('results');
    const recentlyPlayedDiv = document.getElementById('recently-played');
    const yourPlaylistsDiv = document.getElementById('your-playlists');
    const aiRecs = document.getElementById('ai-recommendations');
    const recommendInput = document.getElementById('recommend-input');
    const player = document.getElementById('player');
    const playerCover = document.getElementById('player-cover');
    const playerTitle = document.getElementById('player-title');
    const playerArtist = document.getElementById('player-artist');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const progressBar = document.getElementById('progress-bar');
    const currentTime = document.getElementById('current-time');
    const durationTime = document.getElementById('duration-time');
    const sidebar = document.getElementById('sidebar');
    const welcome = document.getElementById('welcome');

    // YouTube Player Setup
    window.onYouTubeIframeAPIReady = function() {
      ytPlayer = new YT.Player('youtube-player', {
        height: '0',
        width: '0',
        playerVars: { autoplay: 0, controls: 0 },
        events: {
          onReady: () => { playerReady = true; },
          onStateChange: onYtStateChange
        }
      });
    };

    function onYtStateChange(event) {
      if (event.data === YT.PlayerState.ENDED) {
        clearInterval(progressInterval);
        playNext();
      }
      if (event.data === YT.PlayerState.PLAYING) {
        playPauseBtn.textContent = '⏸';
        updateProgress();
      }
      if (event.data === YT.PlayerState.PAUSED) {
        playPauseBtn.textContent = '▶';
      }
    }

    function updateProgress() {
      clearInterval(progressInterval);
      progressInterval = setInterval(() => {
        if (ytPlayer && ytPlayer.getDuration) {
          const curr = ytPlayer.getCurrentTime();
          const dur = ytPlayer.getDuration();
          if (dur > 0) {
            progressBar.value = (curr / dur) * 100;
            currentTime.textContent = formatTime(curr);
            durationTime.textContent = formatTime(dur);
          }
        }
      }, 500);
    }

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s < 10 ? '0' + s : s}`;
    }

    // iTunes API
    async function itunesFetch(query, limit = 20) {
      const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&limit=${limit}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        return (data.results || []).map(t => ({
          id: t.trackId,
          title: t.trackName,
          preview: t.previewUrl,
          artist: { id: t.artistId, name: t.artistName },
          album: {
            cover_medium: t.artworkUrl100?.replace('100x100', '200x200') || t.artworkUrl100,
            cover_big: t.artworkUrl100?.replace('100x100', '600x600') || t.artworkUrl100
          }
        }));
      } catch {
        return [];
      }
    }

    // Play Song
    async function playSong(song, fromPlaylist = false) {
      if (!song?.id) return;
      
      currentSong = song;
      playerTitle.textContent = song.title + ' (Loading...)';
      playerArtist.textContent = song.artist?.name || 'Unknown';
      playerCover.src = song.album?.cover_medium || 'https://via.placeholder.com/56';
      player.style.display = 'block';
      playPauseBtn.textContent = '⏳';
      playPauseBtn.disabled = true;

      // Save to recently played
      const songToSave = {
        id: song.id,
        title: song.title,
        preview: song.preview,
        artist: song.artist,
        album: song.album,
        videoId: song.videoId
      };
      recentlyPlayed = recentlyPlayed.filter(s => s.id !== song.id);
      recentlyPlayed.push(songToSave);
      if (recentlyPlayed.length > 20) recentlyPlayed.shift();
      localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed));

      if (homePage.style.display !== 'none') loadHomeContent();

      // Try YouTube playback
      try {
        let videoId = song.videoId;
        if (!videoId) {
          const query = `${song.title} ${song.artist.name} official audio`;
          videoId = await getVideoId(query);
          song.videoId = videoId;
          // Update saved song with videoId
          const idx = recentlyPlayed.findIndex(s => s.id === song.id);
          if (idx !== -1) {
            recentlyPlayed[idx].videoId = videoId;
            localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed));
          }
        }

        // Load video and wait for user interaction
        if (playerReady && ytPlayer) {
          ytPlayer.loadVideoById(videoId);
          ytPlayer.pauseVideo(); // Don't autoplay
          playerTitle.textContent = song.title + ' (Ready - Click Play)';
          playPauseBtn.textContent = '▶';
          playPauseBtn.disabled = false;
          
          // Try to autoplay (will work if user just clicked)
          setTimeout(() => {
            try {
              ytPlayer.playVideo();
            } catch (e) {
              // Autoplay blocked, that's ok - user can click play button
              console.log('Autoplay blocked, waiting for user interaction');
            }
          }, 100);
        } else {
          // Wait for player to be ready
          playerTitle.textContent = song.title + ' (Waiting for player...)';
          const checkReady = setInterval(() => {
            if (playerReady && ytPlayer) {
              clearInterval(checkReady);
              ytPlayer.loadVideoById(videoId);
              ytPlayer.pauseVideo();
              playerTitle.textContent = song.title + ' (Ready - Click Play)';
              playPauseBtn.textContent = '▶';
              playPauseBtn.disabled = false;
              
              setTimeout(() => {
                try {
                  ytPlayer.playVideo();
                } catch (e) {
                  console.log('Autoplay blocked, waiting for user interaction');
                }
              }, 100);
            }
          }, 100);
          setTimeout(() => {
            clearInterval(checkReady);
            if (!playerReady) {
              showAlert('Player Error', 'YouTube player failed to load. Please refresh the page.');
            }
          }, 5000);
        }
      } catch (err) {
        console.error('Playback error:', err);
        playerTitle.textContent = song.title + ' (Error)';
        playPauseBtn.textContent = '▶';
        playPauseBtn.disabled = false;
        showAlert('Playback Error', 'Could not find this song on YouTube. Try another one!');
      }
    }

    async function getVideoId(query) {
      const apiKey = 'AIzaSyDNd7dwB1rZEpJzpyRrVZQwSKHvnt3Q7vQ';
      const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=1&q=${encodeURIComponent(query)}&key=${apiKey}`);
      const data = await res.json();
      if (data.items?.[0]) return data.items[0].id.videoId;
      throw new Error('No video found');
    }

    function playNext() {
      if (currentPlaylist && currentPlaylist.songs) {
        const next = currentPlaylist.index + 1;
        if (next < currentPlaylist.songs.length) {
          currentPlaylist.index = next;
          playSong(currentPlaylist.songs[next], true);
        }
      }
    }

    // Controls
    playPauseBtn.onclick = () => {
      if (!ytPlayer) return;
      if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
        ytPlayer.pauseVideo();
      } else {
        ytPlayer.playVideo();
      }
    };

    prevBtn.onclick = () => {
      if (currentPlaylist && currentPlaylist.index > 0) {
        currentPlaylist.index--;
        playSong(currentPlaylist.songs[currentPlaylist.index], true);
      }
    };

    nextBtn.onclick = playNext;

    progressBar.oninput = () => {
      if (ytPlayer) {
        const pct = progressBar.value / 100;
        ytPlayer.seekTo(pct * ytPlayer.getDuration(), true);
      }
    };

    // Search
    let searchTimeout;
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      const q = searchInput.value.trim();
      if (!q) {
        results.innerHTML = '';
        return;
      }
      results.innerHTML = '<div class="skeleton"></div>'.repeat(8);
      searchTimeout = setTimeout(async () => {
        const songs = await itunesFetch(q, 30);
        results.innerHTML = '';
        if (!songs.length) {
          results.innerHTML = '<p style="color:#666;text-align:center;padding:40px;">No results found</p>';
          return;
        }
        renderSongs(songs, results);
      }, 400);
    });

    // Recommendations
    let recTimeout;
    recommendInput.addEventListener('input', () => {
      clearTimeout(recTimeout);
      const q = recommendInput.value.trim();
      if (!q) {
        aiRecs.innerHTML = '';
        return;
      }
      aiRecs.innerHTML = '<div class="skeleton"></div>'.repeat(6);
      recTimeout = setTimeout(async () => {
        const songs = await itunesFetch(q, 10);
        aiRecs.innerHTML = '';
        if (songs.length) {
          const artist = songs[0].artist.name;
          const similar = await itunesFetch(artist, 12);
          renderSongs(similar, aiRecs);
        }
      }, 500);
    });

    // Render
    function renderSongs(songs, container) {
      songs.forEach(song => {
        const div = document.createElement('div');
        div.className = 'song-card';
        const isLiked = !!likedArtists[song.artist?.name];
        div.innerHTML = `
          <img class="cover" src="${song.album?.cover_medium || 'https://via.placeholder.com/56'}" alt="cover">
          <div style="flex:1; min-width:0;">
            <div style="font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${song.title}</div>
            <div style="font-size:0.85em; color:var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
              ${song.artist?.name || 'Unknown'}
              <span class="heart-btn ${isLiked ? 'liked' : ''}" onclick="event.stopPropagation(); toggleLikeArtist('${song.artist?.name}', '${song.album?.cover_medium}')">${isLiked ? '♥' : '♡'}</span>
            </div>
          </div>
        `;
        div.onclick = () => playSong(song);
        container.appendChild(div);
      });
    }

    function loadHomeContent() {
      recentlyPlayedDiv.innerHTML = '';
      const recent = recentlyPlayed.slice(-8).reverse();
      if (recent.length) {
        const grid = document.createElement('div');
        grid.className = 'grid-container';
        recent.forEach(s => {
          const div = document.createElement('div');
          div.className = 'grid-card';
          div.innerHTML = `
            <img class="grid-cover" src="${s.album?.cover_medium || 'https://via.placeholder.com/180'}" alt="cover">
            <div class="grid-title">${s.title}</div>
            <div class="grid-artist">${s.artist?.name || 'Unknown'}</div>
          `;
          div.onclick = () => playSong(s);
          grid.appendChild(div);
        });
        recentlyPlayedDiv.appendChild(grid);
      } else {
        recentlyPlayedDiv.innerHTML = '<p style="color:#666;">No recently played songs yet</p>';
      }

      yourPlaylistsDiv.innerHTML = '';
      const plNames = Object.keys(playlists);
      if (plNames.length) {
        const grid = document.createElement('div');
        grid.className = 'grid-container';
        plNames.forEach(name => {
          const pl = playlists[name];
          const div = document.createElement('div');
          div.className = 'grid-card';
          div.innerHTML = `
            <img class="grid-cover" src="${pl.cover || 'https://via.placeholder.com/180?text=♪'}" alt="cover">
            <div class="grid-title">${name}</div>
            <div class="grid-artist">${pl.songs?.length || 0} songs</div>
          `;
          div.onclick = () => loadPlaylist(name);
          grid.appendChild(div);
        });
        yourPlaylistsDiv.appendChild(grid);
      } else {
        yourPlaylistsDiv.innerHTML = '<p style="color:#666;">No playlists yet</p>';
      }
    }

    function loadPlaylist(name) {
      // TODO: Implement playlist loading
      showAlert('Coming Soon', 'Playlist view is being rebuilt!');
    }

    // Liked Artists
    window.toggleLikeArtist = (artistName, coverUrl) => {
      if (likedArtists[artistName]) {
        delete likedArtists[artistName];
      } else {
        likedArtists[artistName] = { name: artistName, cover: coverUrl };
      }
      localStorage.setItem("likedArtists", JSON.stringify(likedArtists));
      renderSidebar();
    };

    function renderSidebar() {
      const items = sidebar.querySelectorAll('.playlist-item, .nav-item');
      items.forEach(el => el.remove());

      // Create Playlist button
      const createBtn = document.createElement('div');
      createBtn.className = 'playlist-item';
      createBtn.innerHTML = '<strong style="color:var(--accent);">+ Create Playlist</strong>';
      createBtn.onclick = async () => {
        const name = await showInputDialog('New Playlist', 'Enter playlist name:');
        if (!name?.trim()) return;
        if (playlists[name.trim()]) {
          showAlert('Error', 'A playlist with that name already exists.');
          return;
        }
        playlists[name.trim()] = { songs: [], cover: null };
        localStorage.setItem("miniPlaylists", JSON.stringify(playlists));
        renderSidebar();
        loadHomeContent();
      };
      sidebar.appendChild(createBtn);

      // Liked Artists
      const likedList = Object.values(likedArtists);
      if (likedList.length) {
        const header = document.createElement('div');
        header.className = 'playlists-header';
        header.textContent = 'Liked Artists';
        sidebar.appendChild(header);

        likedList.forEach(artist => {
          const div = document.createElement('div');
          div.className = 'playlist-item';
          div.innerHTML = `
            <img class="playlist-cover" src="${artist.cover || 'https://via.placeholder.com/42'}" alt="artist">
            <strong style="flex:1;">${artist.name}</strong>
          `;
          sidebar.appendChild(div);
        });
      }

      // Playlists
      const plNames = Object.keys(playlists);
      if (plNames.length) {
        const header = document.createElement('div');
        header.className = 'playlists-header';
        header.textContent = 'Playlists';
        sidebar.appendChild(header);

        plNames.forEach(name => {
          const pl = playlists[name];
          const div = document.createElement('div');
          div.className = 'playlist-item';
          div.innerHTML = `
            <img class="playlist-cover" src="${pl.cover || 'https://via.placeholder.com/42?text=♪'}" alt="cover">
            <strong style="flex:1;">${name}</strong>
          `;
          div.onclick = () => loadPlaylist(name);
          sidebar.appendChild(div);
        });
      }
    }

    // Modal helpers
    function showInputDialog(title, message, defaultValue = '') {
      return new Promise((resolve) => {
        const modal = document.getElementById('input-modal');
        const titleEl = document.getElementById('input-modal-title');
        const inputEl = document.getElementById('input-modal-input');
        const okBtn = document.getElementById('input-modal-ok');
        const cancelBtn = document.getElementById('input-modal-cancel');
        
        titleEl.textContent = title;
        inputEl.value = defaultValue;
        modal.classList.add('active');
        inputEl.focus();
        
        const cleanup = () => {
          modal.classList.remove('active');
          okBtn.onclick = cancelBtn.onclick = null;
        };
        
        okBtn.onclick = () => { cleanup(); resolve(inputEl.value.trim() || null); };
        cancelBtn.onclick = () => { cleanup(); resolve(null); };
      });
    }

    function showAlert(title, message) {
      return new Promise((resolve) => {
        const modal = document.getElementById('alert-modal');
        const titleEl = document.getElementById('alert-modal-title');
        const messageEl = document.getElementById('alert-modal-message');
        const okBtn = document.getElementById('alert-modal-ok');
        
        titleEl.textContent = title;
        messageEl.textContent = message;
        modal.classList.add('active');
        
        okBtn.onclick = () => {
          modal.classList.remove('active');
          okBtn.onclick = null;
          resolve();
        };
      });
    }

    // Navigation
    homeNav.onclick = () => {
      homePage.style.display = 'block';
      searchPage.style.display = 'none';
      homeNav.classList.add('active');
      searchNav.classList.remove('active');
      loadHomeContent();
    };

    searchNav.onclick = () => {
      homePage.style.display = 'none';
      searchPage.style.display = 'block';
      homeNav.classList.remove('active');
      searchNav.classList.add('active');
      searchInput.focus();
    };

    // Greeting
    function updateGreeting() {
      const hour = new Date().getHours();
      let greeting = 'Good evening';
      if (hour >= 5 && hour < 12) greeting = 'Good morning';
      else if (hour < 17) greeting = 'Good afternoon';
      welcome.textContent = `${greeting}, ${userName}`;
    }

    // Profile button
    document.getElementById('profile-btn').onclick = async () => {
      const newName = await showInputDialog('Change Name', 'Enter your name:', userName);
      if (newName && newName.trim()) {
        userName = newName.trim();
        localStorage.setItem("userName", userName);
        updateGreeting();
        document.getElementById('profile-btn').textContent = userName.charAt(0).toUpperCase();
      }
    };

    // Premium button
    document.getElementById('premium-btn').onclick = () => {
      showAlert('Premium', 'Upgrade to Premium for unlimited playback and no ads!');
    };

    // Initialize
    updateGreeting();
    loadHomeContent();
    renderSidebar();
    document.getElementById('profile-btn').textContent = userName.charAt(0).toUpperCase();
  </script>
</body>
</html>
