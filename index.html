<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tunes</title>
    <style>
      :root {
        --bg: linear-gradient(to bottom, #001414, #000);
        --surface: #232323;
        --card: #181818;
        --hover: #282828;
        --text: #fff;
        --text-secondary: #b3b3b3;
        --accent: #fff;
        --border: #000;
        --theme-color: #32CD32;
      }
      * { box-sizing: border-box; }
      body {
        margin:0;
        font-family: 'Circular', 'Helvetica Neue', Arial, sans-serif;
        background:var(--bg);
        color:var(--text);
        display:flex;
        height:100vh;
        overflow:hidden;
        transition: background 0.8s ease;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 16px;
        margin-bottom: 32px;
      }
      .grid-card {
        background: var(--card);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
        position: relative;
      }
      .grid-card:hover {
        background: var(--hover);
      }
      .grid-cover {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
        margin-bottom: 16px;
      }
      .grid-title {
        font-weight: 700;
        font-size: 1rem;
        margin-bottom: 8px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.4;
      }
      .grid-artist {
        font-size: 0.875rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        line-height: 1.4;
      }
      .playlist-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .playlist-header h3 {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 600;
      }
      .playlist-header .btns {
        display: flex;
        gap: 8px;
      }
      .playlist-header button {
        background: transparent;
        border: 1px solid var(--accent);
        color: var(--accent);
        padding: 4px 10px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
      }
      .playlist-header button:hover {
        background: var(--accent);
        color: #fff;
      }
      header {
        position:fixed;
        top:0; left:0; width:100%;
        height:70px;
        padding:0 24px;
        background: transparent;
        display:flex;
        justify-content:space-between;
        align-items:center;
        border-bottom:5px solid var(--border);
        z-index:20;
        border-radius: 0px;
      }
      header h2 {
        margin:0;
        font-size:1.4em;
        font-weight:600;
        background: linear-gradient(90deg, #fff, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .header-right { display:flex; align-items:center; gap:12px; }
      #premium-btn {
        background: var(--theme-color);
        padding:8px 18px;
        border-radius:12px;
        cursor:pointer;
        font-weight:600;
        font-size:0.9em;
        transition:background 0.3s ease, transform 0.2s;
      }
      #premium-btn:hover { transform:scale(1.03); }
      #profile-btn {
        width:36px; height:36px;
        background:#333;
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        font-weight:bold;
        font-size:1em;
        transition:0.2s;
        overflow:hidden;
      }
      #profile-btn img {
        width:100%; height:100%; object-fit:cover;
      }
      #profile-btn:hover { background:#444; }
      #profile-popup {
        position:fixed; top:80px; right:24px;
        background:var(--card);
        padding:20px;
        border-radius:14px;
        width:300px;
        box-shadow:0 8px 24px rgba(0,0,0,0.4);
        display:none;
        z-index:100;
        border:5px solid var(--border);
      }
      #profile-popup h4 { margin:0 0 8px; font-size:1.1em; }
      #profile-popup p { margin:4px 0; font-size:0.9em; color:#aaa; }
      #profile-avatar {
        width:80px; height:80px; border-radius:50%; margin:0 auto 12px; display:block; object-fit:cover;
      }
      #upload-avatar, #upload-playlist-cover { display:none; }
      .upload-btn {
        background:var(--hover);
        border:none;
        color:var(--text);
        padding:6px 12px;
        border-radius:8px;
        cursor:pointer;
        width:100%;
        margin-top:8px;
        font-size:0.9em;
        text-align:center;
      }
      #bio-input {
        width:100%; height:80px; background:var(--card); border:none; border-radius:8px; color:var(--text); padding:8px; margin-top:8px; resize:none;
      }
      #bio-input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }
      #sidebar {
        width:340px;
        background:var(--surface);
        padding-top:90px;
        overflow-y:auto;
        border-right:5px solid var(--border);
        display:flex;
        flex-direction:column;
        border-radius: 15px;
      }
      .nav-item {
        display:flex;
        align-items:center;
        padding:14px 16px;
        cursor:pointer;
        gap:14px;
        transition:0.2s;
        border-bottom:0px solid var(--border);
        font-weight:500;
      }
      .nav-item:hover { background:var(--hover); }
      .nav-item.active {
        background:var(--hover);
        border-left:3px solid var(--accent);
        padding-left:13px;
      }
      .nav-item svg { width:20px; height:20px; fill: #aaa; }
      .nav-item.active svg { fill: var(--accent); }
      .playlists-header {
        padding:16px 16px 8px;
        font-size:0.9em;
        color:#aaa;
        letter-spacing:0.5px;
        font-weight:600;
      }
      .playlist-item {
        display:flex;
        align-items:center;
        padding:12px 16px;
        cursor:pointer;
        gap:12px;
        transition:0.2s;
        border-bottom:1px solid var(--border);
        position:relative;
        overflow:hidden;
      }
      .playlist-item:hover { background:var(--hover); }
      .playlist-cover { width:42px; height:42px; object-fit:cover; border-radius:50%; }
      .playlist-actions {
        margin-left:auto;
        display:flex;
        gap:6px;
        opacity:1;
        transition:0.2s;
        position:static;
        background:none;
        padding:0;
        border-radius:8px;
      }
      .playlist-actions button {
        font-size: 0.75rem;
        padding: 4px 8px;
      }
      #content {
        flex:1;
        padding:90px 32px 20px 32px;
        overflow-y:auto;
      }
      .section { margin-bottom:36px; }
      .section h3 { margin:0 0 16px; font-size:1.3em; font-weight:600; color:#eee; }
      .song-card {
        background:transparent;
        padding:16px;
        border-radius:14px;
        display:flex;
        gap:16px;
        align-items:center;
        transition:0.25s;
        cursor:pointer;
        margin-bottom:14px;
        justify-content:space-between;
        box-shadow:0 2px 6px rgba(0,0,0,0.2);
      }
      .song-card:hover {
        background:var(--hover);
        transform:translateY(-2px);
        box-shadow:0 6px 12px rgba(0,0,0,0.3);
      }
      .cover { width:64px; height:64px; object-fit:cover; border-radius:12px; box-shadow:0 2px 4px rgba(0,0,0,0.3); }
      #player {
        position:sticky;
        bottom:0;
        background:transparent;
        padding:16px 24px;
        border-top:1px solid var(--border);
        display:none;
        width:100%;
        box-sizing:border-box;
        backdrop-filter: blur(10px);
      }
      #now-playing { margin:0 0 8px; font-weight:500; font-size:0.95em; }
      input, button, textarea { font-family: inherit; }
      input {
        width:100%;
        padding:14px 16px;
        background:var(--card);
        border:none;
        border-radius:12px;
        color:var(--text);
        margin-bottom:20px;
        font-size:1em;
        transition:0.2s;
      }
      input:focus { outline:none; box-shadow:0 0 0 2px var(--accent); }
      button {
        cursor:pointer;
        background:var(--hover);
        color:var(--text);
        border:none;
        padding:8px 16px;
        border-radius:10px;
        margin-left:8px;
        transition:0.2s;
        font-weight:500;
      }
      button:hover { background:#333; }
      .skeleton {
        height:78px;
        background:linear-gradient(90deg,#202020,#2a2a2a,#202020);
        background-size:200% 100%;
        animation:loading 1.4s infinite;
        border-radius:14px;
        margin-bottom:14px;
      }
      @keyframes loading { 0% { background-position:200% 0; } 100% { background-position:-200% 0; } }
      #welcome {
        font-size:1.8em;
        margin-bottom:24px;
        font-weight:600;
        background: linear-gradient(90deg, #fff, #aaa);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      #premium-popup {
        position:fixed;
        background:var(--card);
        padding:24px;
        border-radius:16px;
        box-shadow:0 12px 32px rgba(0,0,0,0.5);
        z-index:100;
        border:1px solid var(--border);
        top:50%; left:50%;
        transform:translate(-50%,-50%);
        width:340px;
        text-align:center;
        display:none;
      }
      #search-results-title {
        margin: 20px 0 16px;
        font-size: 1.3em;
        font-weight: 600;
        color: #eee;
        display: none;
      }
      .modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }
      .modal-overlay.active {
        display: flex;
      }
      .modal-box {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        width: 90%;
        max-width: 400px;
        box-shadow: 0 12px 32px rgba(0,0,0,0.6);
      }
      .modal-box h3 {
        margin: 0 0 12px;
        font-size: 1.2em;
      }
      .modal-box p {
        margin: 0 0 20px;
        color: #aaa;
      }
      .modal-box input {
        margin-bottom: 16px;
      }
      .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
      .modal-buttons button {
        margin: 0;
        padding: 10px 20px;
      }
      .modal-buttons .primary {
        background: var(--accent);
        color: #fff;
      }
      .modal-buttons .primary:hover {
        background: #6a00d8;
      }
      .playlist-select-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 16px;
      }
      .playlist-select-item {
        background: var(--hover);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: 0.2s;
      }
      .playlist-select-item:hover {
        background: #333;
      }
      #main-wrapper {
        display: flex;
        height: calc(100vh - 10px);
        flex: 1;
        border: 5px solid var(--border);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
      }
      .playlist-view-header {
        text-align: center;
        margin: 0 0 40px;
        padding: 20px 0;
      }
      .playlist-big-cover {
        width: 280px;
        height: 280px;
        object-fit: cover;
        border-radius: 16px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.7);
        margin: 0 auto 24px;
        display: block;
      }
      .playlist-view-title {
        font-size: 2.8rem;
        font-weight: 900;
        margin: 0;
        background: linear-gradient(90deg, #fff, #ccc);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .playlist-view-song-count {
        color: #aaa;
        font-size: 1rem;
        margin-top: 8px;
      }
      #right-sidebar {
        width: 340px;
        background: var(--surface);
        padding-top: 90px;
        border-left: 5px solid var(--border);
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        flex-shrink: 0;
        transition: width 0.4s ease;
      }
      #right-sidebar.hidden {
        width: 0 !important;
        padding: 0;
        overflow: hidden;
      }
      #now-playing-sidebar {
        width: 100%;
        padding: 20px;
        text-align: center;
        display: none;
      }
      #now-playing-cover {
        width: 290px;
        height: 290px;
        object-fit: cover;
        border-radius: 16px;
        margin: 0 auto 24px;
        display: block;
        box-shadow: 0 12px 32px rgba(0,0,0,0.7);
      }
      #now-playing-info {
        margin-top: 12px;
      }
      #now-playing-title {
        font-size: 1.1em;
        font-weight: 700;
        display: block;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #now-playing-artist {
        color: #aaa;
        margin: 0 0 16px;
        font-size: 0.95em;
      }
      #add-current-to-playlist {
        background: var(--hover);
        color: var(--text);
        border: none;
        padding: 10px 20px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        width: 80%;
        transition: 0.2s;
        margin: 0;
      }
      #add-current-to-playlist:hover {
        background: var(--accent);
        color: #000;
      }
      #lyrics-section {
        width: 100%;
        padding: 20px;
        margin-top: 20px;
        display: none;
      }
      #lyrics-section h4 {
        margin: 0 0 12px;
        font-size: 1.1em;
        font-weight: 600;
        text-align: center;
      }
      #lyrics-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 12px;
        padding: 20px;
        max-height: 400px;
        overflow-y: auto;
        transition: background 0.8s ease;
      }
      #lyrics-text {
        color: #fff;
        line-height: 1.8;
        font-size: 0.95em;
        white-space: pre-wrap;
        text-align: center;
      }
      #lyrics-text.loading {
        color: #aaa;
        font-style: italic;
      }
      #lyrics-container::-webkit-scrollbar {
        width: 8px;
      }
      #lyrics-container::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 4px;
      }
      #lyrics-container::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 4px;
      }
      #lyrics-container::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
      }
      .header-center {
        display: flex;
        gap: 8px;
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
      }
      .header-center .nav-item {
        padding: 8px 16px;
        border-radius: 20px;
        border-bottom: none;
        font-size: 0.9em;
        background: rgba(255, 255, 255, 0.1);
        transition: background 0.2s ease;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
      }
      .header-center .nav-item:hover {
        background: rgba(255, 255, 255, 0.15);
      }
      .header-center .nav-item.active {
        background: rgba(255, 255, 255, 0.2);
        border-left: none;
        padding-left: 16px;
      }
      .header-center .nav-item span {
        font-weight: 500;
      }
      .header-center .nav-item svg {
        width: 16px;
        height: 16px;
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 12px;
        margin-bottom: 32px;
      }
      .grid-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 12px;
        cursor: pointer;
        transition: background 0.3s ease;
        position: relative;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .grid-card:hover {
        background: rgba(255, 255, 255, 0.1);
      }
      .grid-cover {
        width: 64px;
        height: 64px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
        flex-shrink: 0;
      }
      .grid-title {
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 4px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.3;
      }
      .grid-artist {
        font-size: 0.8rem;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        line-height: 1.3;
      }
      #sidebar {
        border-radius: 0 !important; /* Remove left sidebar corners */
      }
      #right-sidebar {
        border-radius: 0 !important; /* Remove right sidebar corners */
      }
      #main-wrapper {
        border-radius: 0 !important; /* Also remove the main wrapper corners if desired */
      }
      .heart-btn {
        margin-left: 8px;
        font-size: 1.1em;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s, transform 0.2s;
      }
      .heart-btn:hover {
        opacity: 1;
        transform: scale(1.2);
      }
      .heart-btn.liked {
        color: #e91e63;
        opacity: 1;
      }
      .search-text {
        color: #D3D3D3;
        opacity: 1;
      }
      .playlists-header {
        padding: 16px 16px 8px;
        font-size: 0.9em;
        color: #aaa;
        letter-spacing: 0.5px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px; /* space between icon and text */
      }
      .library-icon {
        height: 28px; /* Adjust this to match text height perfectly */
        width: auto;
        object-fit: contain;
      }
      .playlists-header:hover .library-icon {
        opacity: 1; /* Optional: brighten icon on hover */
      }
      .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px; /* increased from 12px for breathing room */
        margin-bottom: 40px;
      }
      .grid-card {
        background: var(--card);
        border-radius: 8px;
        padding: 16px;
        cursor: pointer;
        transition: background 0.3s ease;
        display: flex;
        flex-direction: column; /* vertical layout again */
        gap: 12px;
      }
      .grid-cover {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
      }
      .grid-title {
        font-size: 1rem;
        margin-bottom: 4px;
      }
      .grid-artist {
        font-size: 0.875rem;
      }
      /* Special style for Recently Played songs – keep classic horizontal song cards */
      #recently-played .song-card {
        background: transparent;
        padding: 12px 16px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        gap: 16px;
        transition: 0.25s;
        cursor: pointer;
        box-shadow: none;
      }
      #recently-played .song-card:hover {
        background: var(--hover);
        transform: translateY(-2px);
      }
      #recently-played .cover {
        width: 56px;
        height: 56px;
        border-radius: 8px;
        flex-shrink: 0;
      }
      #recently-played .song-info {
        flex: 1;
      }
      #recently-played .song-title {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
      }
      #recently-played .song-artist {
        font-size: 0.875rem;
        color: var(--text-secondary);
      }
      /* Recently Played: Compact 4-column grid with square full-size covers */
      #recently-played {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 16px;
        margin-top: 12px;
      }
      #recently-played .grid-card {
        /* Reuse the modern full-image grid-card style */
        background: var(--card);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      #recently-played .grid-cover {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
      }
      #recently-played .grid-title {
        font-size: 0.95rem;
        font-weight: 700;
      }
      #recently-played .grid-artist {
        font-size: 0.85rem;
      }
      /* Show full album artwork without aggressive cropping */
      .grid-cover {
        object-fit: contain !important; /* Show entire image */
        background: #000; /* Black letterbox background */
        padding: 8px; /* Optional: small inner spacing so edges aren't cut off */
        box-sizing: border-box;
      }
      /* Allow grid cards to grow based on image aspect ratio */
      .grid-card {
        display: grid;
        grid-template-rows: 1fr auto; /* image takes needed height, text fixed below */
        align-items: end; /* text at bottom */
      }
      .grid-cover {
        width: 100%;
        height: auto; /* let image determine its own height */
        max-height: none; /* remove any constraints */
        aspect-ratio: unset; /* don't force square */
        object-fit: contain;
        background: #000; /* black letterbox for wide images */
        border-radius: 4px 4px 0 0;
        grid-row: 1;
      }
      .grid-card > div { /* the title/artist wrapper */
        grid-row: 2;
        padding: 12px 16px 16px;
        background: var(--card); /* ensure text area has background */
        border-radius: 0 0 8px 8px;
      }
      .grid-artist {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .grid-container {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px;
      }
      /* 1. Reset to clean full-cover square cards (no cropping, no extreme growth) */
      .grid-cover {
        width: 100%;
        aspect-ratio: 1 !important;
        object-fit: cover !important; /* Fill square nicely, slight crop if needed (rare) */
        background: transparent;
        padding: 0;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
      }
      /* Remove the adaptive grid that caused exploding heights */
      .grid-card {
        display: flex !important;
        flex-direction: column;
        align-items: stretch;
      }
      /* 2. Truncate long artist lists to one line with "..." */
      .grid-artist {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        -webkit-line-clamp: unset !important; /* override any multi-line */
      }
      /* 3. Make Recently Played a compact 4-column grid (consistent with others) */
      #recently-played {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px;
        margin-top: 16px;
      }
      /* Optional: Slightly smaller text in Recently Played for compactness */
      #recently-played .grid-title {
        font-size: 0.95rem;
      }
      #recently-played .grid-artist {
        font-size: 0.85rem;
      }
      /* Force Recently Played back to classic horizontal song cards */
      #recently-played {
        display: block !important; /* Override grid */
        margin-top: 16px;
      }
      #recently-played .grid-card {
        display: flex !important;
        flex-direction: row !important;
        align-items: center;
        gap: 16px;
        padding: 12px 16px;
        background: transparent;
        border-radius: 12px;
        box-shadow: none;
      }
      #recently-played .grid-card:hover {
        background: var(--hover);
        transform: translateY(-2px);
      }
      #recently-played .grid-cover {
        width: 64px !important;
        height: 64px !important;
        aspect-ratio: unset !important;
        flex-shrink: 0;
        border-radius: 8px;
      }
      #recently-played .grid-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 4px;
        -webkit-line-clamp: 1;
      }
      #recently-played .grid-artist {
        font-size: 0.875rem;
        -webkit-line-clamp: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Keep all other sections in full-cover grid style */
      #your-playlists .grid-container,
      [data-section="recent-albums"] .grid-container,
      [data-section="made-for-you"] .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 24px;
      }
      /* Clean cover display (no cropping issues) */
      .grid-cover {
        object-fit: cover; /* Safe for square iTunes art */
      }
      /* Clean horizontal Recently Played cards with proper long text handling */
      #recently-played {
        display: block !important;
        margin-top: 16px;
      }
      #recently-played .grid-card {
        display: flex !important;
        flex-direction: row;
        align-items: center;
        gap: 16px;
        padding: 14px 16px;
        background: transparent;
        border-radius: 12px;
        box-shadow: none;
        margin-bottom: 8px;
      }
      #recently-played .grid-card:hover {
        background: var(--hover);
      }
      #recently-played .grid-cover {
        width: 60px;
        height: 60px;
        flex-shrink: 0;
        border-radius: 8px;
        object-fit: cover;
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
      }
      /* Text container that takes remaining space */
      #recently-played .text-container {
        flex: 1;
        min-width: 0; /* Crucial: allows truncation inside flex */
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
      #recently-played .grid-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 4px;
      }
      #recently-played .grid-artist {
        font-size: 0.875rem;
        color: var(--text-secondary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      /* Recently Played: Compact responsive grid (aims for ~4 columns) */
      #recently-played {
        display: grid !important;
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Slightly smaller min-width for 4-5 columns */
        gap: 20px;
        margin-top: 16px;
      }
      /* Ensure cards look consistent and modern */
      #recently-played .grid-card {
        background: var(--card);
        border-radius: 8px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      #recently-played .grid-cover {
        width: 100%;
        aspect-ratio: 1;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 8px 24px rgba(0,0,0,.5);
      }
      /* Truncate long text cleanly */
      #recently-played .grid-title,
      #recently-played .grid-artist {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      #recently-played .grid-title {
        font-size: 0.95rem;
        font-weight: 700;
      }
      #recently-played .grid-artist {
        font-size: 0.85rem;
      }
      /* Force Recently Played into exactly 4 columns × 2 rows (8 cards max) */
      #recently-played {
        display: grid !important;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        margin-top: 16px;
      }
      /* On smaller screens (e.g. tablets), fall back to 2 columns so it doesn't look cramped */
      @media (max-width: 1024px) {
        #recently-played {
          grid-template-columns: repeat(2, 1fr);
        }
      }
      /* On mobile, stack them */
      @media (max-width: 640px) {
        #recently-played {
          grid-template-columns: 1fr;
        }
      }
      /* Ensure Recently Played cards stay uniform width and truncate long titles */
      #recently-played .grid-card {
        width: 100%; /* Take full available column width */
        max-width: 100%;
        overflow: hidden; /* Prevent text from spilling out */
      }
      #recently-played .grid-title {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        font-size: 0.95rem;
        font-weight: 700;
        line-height: 1.3;
        margin-bottom: 4px;
      }
      #recently-played .grid-artist {
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        font-size: 0.85rem;
        color: var(--text-secondary);
      }
      /* Optional: Slightly tighter padding for compactness */
      #recently-played .grid-card {
        padding: 14px;
      }
      /* New styles for custom player controls */
      #controls {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
        margin: 8px 0;
      }
      #controls button {
        background: var(--hover);
        color: var(--text);
        border: none;
        padding: 8px 16px;
        border-radius: 50%;
        font-size: 1.2em;
        cursor: pointer;
      }
      #controls button:hover {
        background: var(--accent);
        color: #000;
      }
      #progress-bar {
        -webkit-appearance: none;
        appearance: none;
        width: 100%;
        height: 6px;
        background: #444;
        outline: none;
        opacity: 0.7;
        transition: opacity .2s;
      }
      #progress-bar:hover {
        opacity: 1;
      }
      #progress-bar::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
      }
      #progress-bar::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: var(--accent);
        cursor: pointer;
        border-radius: 50%;
      }
      #time-display {
        display: block;
        text-align: center;
        color: var(--text-secondary);
        font-size: 0.85em;
        margin-top: 4px;
      }
    </style>
  </head>
  <body>
    <div id="main-wrapper">
      <header>
        <h2>Tunes</h2>
        <div class="header-center">
          <div id="home-nav" class="nav-item active">
            <svg viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path></svg>
          </div>
          <div id="search-nav" class="nav-item">
            <svg viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l4.5 4.5a1 1 0 0 1-1.42 1.42l-4.5-4.5v-.79l-.27-.27A6.5 6.5 0 1 1 9.5 3zm0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"></path></svg>
            <span class="search-text">What do you want to play?</span>
          </div>
        </div>
        <div class="header-right">
          <div id="premium-btn">Premium</div>
          <div id="profile-btn">?</div>
        </div>
      </header>
      <div id="profile-popup">
        <img id="profile-avatar" src="https://via.placeholder.com/80" alt="Profile">
        <h4 id="profile-name">User</h4>
        <p>Customize your experience</p>
        <button class="upload-btn" id="change-avatar-btn">Change Avatar</button>
        <input type="file" id="upload-avatar" accept="image/*">
        <textarea id="bio-input" placeholder="Write your bio... (private)"></textarea>
        <button class="upload-btn" id="change-name">Change Name</button>
      </div>
      <div id="sidebar">
        <div class="playlists-header">
          <img src="https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTRRER-jmDL_536YJ2jSioqNRxEkkMJAuUSGQ&s"
               alt="Library icon"
               class="library-icon">
          Your Library
        </div>
      </div>
      <div id="content">
        <div id="home-page">
          <div id="welcome">Good day, User</div>
          <div class="section">
            <h3>Recently Played</h3>
            <div id="recently-played"></div>
          </div>
          <div class="section">
            <h3>Your Playlists</h3>
            <div id="your-playlists"></div>
          </div>
          <div class="section">
            <h3>DJ Suggestions</h3>
            <input id="recommend-input" placeholder="Have your personal DJ recommend songs based on other songs">
            <div id="ai-recommendations"></div>
          </div>
        </div>
        <div id="search-page" style="display:none;">
          <input id="search" placeholder="Search for songs, artists, albums...">
          <div id="popular-section">
            <h3>Popular Right Now</h3>
            <div id="popular"></div>
          </div>
          <h3 id="search-results-title">Search Results</h3>
          <div id="results"></div>
        </div>
        <div id="player">
          <p id="now-playing">Now playing...</p>
          <div id="controls">
            <button id="prev-btn">&#9664;&#9664;</button>
            <button id="play-pause-btn">&#9654;</button>
            <button id="next-btn">&#9654;&#9654;</button>
          </div>
          <input type="range" id="progress-bar" value="0" min="0" max="100">
          <span id="time-display">0:00 / 0:00</span>
        </div>
        <div id="lyrics-viewer" style="margin-top:24px; padding:16px; background:var(--card); border-radius:12px; display:none;">
          <h4>Lyrics</h4>
          <p id="lyrics-text-old">Loading lyrics...</p>
        </div>
      </div>
      <div id="right-sidebar">
        <div id="now-playing-sidebar">
          <h3>Audio Menu</h3>
          <img id="now-playing-cover" src="https://via.placeholder.com/240" alt="Cover">
          <div id="now-playing-info">
            <strong id="now-playing-title">Nothing playing</strong>
            <p id="now-playing-artist"></p>
            <button id="add-current-to-playlist">Add to Playlist</button>
          </div>
        </div>
        <div id="lyrics-section">
          <h4>Lyrics</h4>
          <div id="lyrics-container">
            <p id="lyrics-text" class="loading">No lyrics available</p>
          </div>
        </div>
      </div>
    </div>
    <div id="premium-popup">
      <h3>Mini Tunes Premium</h3>
      <p>Only <strong>$3/year, $0.25/month</strong>! Get points every clip listened to + an access code to BETA TV!</p>
      <button onclick="closePremium()">Close</button>
    </div>
    <input type="file" id="upload-playlist-cover" accept="image/*" style="display:none;">
    <div id="input-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="input-modal-title">Input</h3>
        <p id="input-modal-message"></p>
        <input type="text" id="input-modal-input">
        <div class="modal-buttons">
          <button id="input-modal-cancel">Cancel</button>
          <button id="input-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>
    <div id="alert-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="alert-modal-title">Notice</h3>
        <p id="alert-modal-message"></p>
        <div class="modal-buttons">
          <button id="alert-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>
    <div id="confirm-modal" class="modal-overlay">
      <div class="modal-box">
        <h3 id="confirm-modal-title">Confirm</h3>
        <p id="confirm-modal-message"></p>
        <div class="modal-buttons">
          <button id="confirm-modal-cancel">Cancel</button>
          <button id="confirm-modal-ok" class="primary">OK</button>
        </div>
      </div>
    </div>
    <div id="playlist-select-modal" class="modal-overlay">
      <div class="modal-box">
        <h3>Add to Playlist</h3>
        <div class="playlist-select-list" id="playlist-select-list"></div>
        <div class="modal-buttons">
          <button id="playlist-select-cancel">Cancel</button>
        </div>
      </div>
    </div>
    <div id="youtube-player" style="display:none; width:0; height:0;"></div>
    <script async defer src="https://www.youtube.com/iframe_api"></script>
    <script>
     // ====================== COLOR EXTRACTION & GRADIENT ======================
function extractColorsFromImage(imageUrl) {
  return new Promise((resolve) => {
    const img = new Image();
    img.crossOrigin = "Anonymous";
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      try {
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const colors = [];
       
        // Sample pixels from the image
        for (let i = 0; i < imageData.data.length; i += 4 * 10) {
          const r = imageData.data[i];
          const g = imageData.data[i + 1];
          const b = imageData.data[i + 2];
         
          // Skip very dark or very light colors
          const brightness = (r + g + b) / 3;
          if (brightness > 30 && brightness < 220) {
            colors.push({ r, g, b });
          }
        }
        // Find dominant color
        if (colors.length > 0) {
          const avgColor = colors.reduce((acc, c) => ({
            r: acc.r + c.r,
            g: acc.g + c.g,
            b: acc.b + c.b
          }), { r: 0, g: 0, b: 0 });
          avgColor.r = Math.floor(avgColor.r / colors.length);
          avgColor.g = Math.floor(avgColor.g / colors.length);
          avgColor.b = Math.floor(avgColor.b / colors.length);
          resolve(avgColor);
        } else {
          resolve({ r: 0, g: 20, b: 20 }); // Default dark teal
        }
      } catch (e) {
        // CORS error or other issue - use default
        resolve({ r: 0, g: 20, b: 20 });
      }
    };
    img.onerror = () => resolve({ r: 0, g: 20, b: 20 });
    img.src = imageUrl;
  });
}
function applyGradientFromColor(color) {
  const { r, g, b } = color;
  const darkerR = Math.max(0, Math.floor(r * 0.3));
  const darkerG = Math.max(0, Math.floor(g * 0.3));
  const darkerB = Math.max(0, Math.floor(b * 0.3));
 
  const gradient = `linear-gradient(to bottom, rgb(${r}, ${g}, ${b}), rgb(${darkerR}, ${darkerG}, ${darkerB}), #000)`;
  document.body.style.background = gradient;
}
// Modify the playSong function to update gradient and refresh artists
const originalPlaySong = window.playSong;
window.playSong = async function(song, fromPlaylist = false) {
  await originalPlaySong.call(this, song, fromPlaylist);
 
  // Extract color and apply gradient
  if (song?.album?.cover_medium || song?.album?.cover_big) {
    const coverUrl = song.album.cover_big || song.album.cover_medium;
    const color = await extractColorsFromImage(coverUrl);
    applyGradientFromColor(color);
  }
 
  // Refresh top artists sidebar after each song
  renderLikedArtistsSidebar();
};
// ====================== AUTO-GENERATED PLAYLISTS ======================
function generateAutoPlaylists() {
  const recent = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
  if (recent.length === 0) return null;
  // Get artist play counts
  const artistCounts = {};
  recent.forEach(song => {
    const artist = song.artist?.name || "Unknown";
    artistCounts[artist] = (artistCounts[artist] || 0) + 1;
  });
  // Sort artists by play count
  const sortedArtists = Object.entries(artistCounts)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5);
  // Create "Top Artists Mix" playlist
  const topArtistsMix = recent
    .filter(song => sortedArtists.some(([artist]) => artist === song.artist?.name))
    .slice(-20);
  // Create "Recent Favorites" playlist (last 15 songs)
  const recentFavorites = recent.slice(-15);
  return {
    "Your Recent Favorites": {
      songs: recentFavorites,
      auto: true,
      cover: recentFavorites[recentFavorites.length - 1]?.album?.cover_medium
    },
    "Daily Radio": {
      songs: topArtistsMix,
      auto: true;
      cover: topArtistsMix[topArtistsMix.length - 1]?.album?.cover_medium
    }
  };
}
function renderAutoPlaylists() {
  const autoPlaylists = generateAutoPlaylists();
  if (!autoPlaylists) return;
  const homePage = document.getElementById("home-page");
  if (!homePage) return;
  // Remove existing "Made For You" section if it exists
  const existingSection = homePage.querySelector('[data-section="made-for-you"]');
  if (existingSection) {
    existingSection.remove();
  }
  // Create auto-playlists section on home page
  const autoSection = document.createElement('div');
  autoSection.setAttribute('data-section', 'made-for-you');
  autoSection.style.marginBottom = '32px';
 
  const title = document.createElement('h3');
  title.textContent = 'Made For You';
  title.style.margin = '0 0 16px';
  title.style.fontSize = '1.3em';
  title.style.fontWeight = '600';
  title.style.color = '#eee';
 
  const grid = document.createElement('div');
  grid.className = 'grid-container';
 
  Object.entries(autoPlaylists).forEach(([name, playlist]) => {
    const div = document.createElement('div');
    div.className = 'grid-card';
    const cover = playlist.cover || 'https://via.placeholder.com/180?text=♪';
   
    div.innerHTML = `
      <img class="grid-cover" src="${cover}" alt="cover">
      <div class="grid-title">${name}</div>
      <div class="grid-artist">${playlist.songs.length} songs</div>
    `;
   
    div.onclick = () => loadAutoPlaylist(name, playlist);
    grid.appendChild(div);
  });
 
  autoSection.appendChild(title);
  autoSection.appendChild(grid);
 
  // Insert as first child of home page (after welcome)
  const welcome = document.getElementById("welcome");
  if (welcome && welcome.nextElementSibling) {
    welcome.parentElement.insertBefore(autoSection, welcome.nextElementSibling);
  } else {
    homePage.insertBefore(autoSection, homePage.firstChild);
  }
}
function loadAutoPlaylist(name, playlist) {
  const searchPage = document.getElementById('search-page');
  const homePage = document.getElementById('home-page');
  const searchInput = document.getElementById('search');
  const results = document.getElementById('results');
  const popularSection = document.getElementById('popular-section');
  const searchResultsTitle = document.getElementById('search-results-title');
 
  homePage.style.display = 'none';
  searchPage.style.display = 'block';
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';
  const cover = playlist.cover || 'https://via.placeholder.com/280?text=♪';
  results.innerHTML = `
    <div class="playlist-view-header">
      <img class="playlist-big-cover" src="${cover}" alt="cover">
      <h1 class="playlist-view-title">${name}</h1>
      <p class="playlist-view-song-count">${playlist.songs.length} song${playlist.songs.length !== 1 ? 's' : ''}</p>
    </div>
  `;
  const container = document.createElement('div');
  if (!playlist.songs.length) {
    container.innerHTML = '<p style="text-align:center;color:#888;padding:60px;">This playlist is empty.</p>';
  } else {
    playlist.songs.forEach((song, i) => {
      const div = document.createElement('div');
      div.className = 'song-card';
      const artist = song.artist?.name || "Unknown";
      const coverSrc = song.album?.cover_medium || 'https://via.placeholder.com/64';
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:16px;">
          <img class="cover" src="${coverSrc}" alt="cover">
          <div>
            <strong>${song.title}</strong><br>
            <small style="color:#aaa;">${artist}</small>
          </div>
        </div>
      `;
      div.onclick = () => {
        window.currentSong = song;
        window.playSong(song);
      };
      container.appendChild(div);
    });
  }
  results.appendChild(container);
}
// ====================== LIKED ARTISTS (HEART SYSTEM) ======================
let likedArtists = JSON.parse(localStorage.getItem("likedArtists") || "{}");
// Format: { "Artist Name": { name, cover } }
function toggleLikeArtist(artistName, coverUrl) {
  if (likedArtists[artistName]) {
    delete likedArtists[artistName];
  } else {
    likedArtists[artistName] = {
      name: artistName,
      cover: coverUrl || 'https://via.placeholder.com/42'
    };
  }
  localStorage.setItem("likedArtists", JSON.stringify(likedArtists));
  renderLikedArtistsSidebar(); // Update sidebar
}
function renderLikedArtistsSidebar() {
  const sidebar = document.getElementById('sidebar');
  // Remove old Liked Artists section
  const existingHeader = sidebar.querySelector('.playlists-header[data-type="liked-artists"]');
  if (existingHeader) {
    let next = existingHeader.nextElementSibling;
    while (next && next.classList.contains('liked-artist-item')) {
      next.remove();
      next = existingHeader.nextElementSibling;
    }
    existingHeader.remove();
  }
  const likedList = Object.values(likedArtists);
  if (likedList.length === 0) return;
  // Add header
  const header = document.createElement('div');
  header.className = 'playlists-header';
  header.setAttribute('data-type', 'liked-artists');
  header.textContent = '♥️ Liked Artists';
  sidebar.appendChild(header);
  // Add artists
  likedList.forEach(artist => {
    const div = document.createElement('div');
    div.className = 'playlist-item liked-artist-item';
    div.innerHTML = `
      <img class="playlist-cover" src="${artist.cover}" alt="artist">
      <strong style="flex:1;">${artist.name}</strong>
      <span class="heart-btn liked" onclick="event.stopPropagation(); toggleLikeArtist('${artist.name}', '${artist.cover}')">♥️</span>
    `;
    div.onclick = () => loadArtistSongs(artist.name);
    sidebar.appendChild(div);
  });
}
// Helper: Load songs by artist (for clicking liked artist)
async function loadArtistSongs(artistName) {
  showSearch();
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';
  searchResultsTitle.textContent = `Songs by ${artistName}`;
  searchResultsTitle.style.display = 'block';
  results.innerHTML = '<p style="text-align:center;color:#888;padding:40px;">Loading songs...</p>';
  const songs = await itunesFetch(artistName, 30);
  results.innerHTML = '';
  if (!songs.length) {
    results.innerHTML = '<p style="text-align:center;color:#888;">No songs found.</p>';
    return;
  }
  const container = document.createElement('div');
  songs.forEach(song => {
    const div = document.createElement('div');
    div.className = 'song-card';
    const coverSrc = song.album?.cover_medium || 'https://via.placeholder.com/64';
    const isLiked = !!likedArtists[song.artist?.name];
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;flex:1;">
        <img class="cover" src="${coverSrc}" alt="cover">
        <div style="flex:1;">
          <strong>${song.title}</strong><br>
          <small style="color:#aaa;">
            ${song.artist?.name || 'Unknown'}
            <span class="heart-btn ${isLiked ? 'liked' : ''}"
                  onclick="event.stopPropagation(); toggleLikeArtist('${song.artist?.name || 'Unknown'}', '${coverSrc}')">
              ${isLiked ? '♥️' : '♡'}
            </span>
          </small>
        </div>
      </div>
    `;
    div.onclick = () => playSong(song);
    container.appendChild(div);
  });
  results.appendChild(container);
}
// ====================== INITIALIZE ======================
// Override loadHomeContent to include auto playlists
const originalLoadHomeContent = window.loadHomeContent;
window.loadHomeContent = function() {
  originalLoadHomeContent.call(this);
  renderAutoPlaylists();
};
// Initialize on page load
window.addEventListener('load', () => {
  renderLikedArtistsSidebar();
 
  // Refresh top artists when returning to home
  const homeNav = document.getElementById('home-nav');
  const originalHomeClick = homeNav.onclick;
  homeNav.onclick = function() {
    originalHomeClick.call(this);
    renderLikedArtistsSidebar();
  };
});
    </script>
    <script>
      // ====================== LYRICS FEATURE ======================
let currentGradientColor = { r: 0, g: 20, b: 20 }; // Store current color
// Update the applyGradientFromColor function to store the color
const originalApplyGradient = window.applyGradientFromColor;
window.applyGradientFromColor = function(color) {
  currentGradientColor = color;
  originalApplyGradient(color);
 
  // Update lyrics container background
  const lyricsContainer = document.getElementById('lyrics-container');
  if (lyricsContainer) {
    lyricsContainer.style.background = `rgba(${color.r}, ${color.g}, ${color.b}, 0.2)`;
  }
};
// Fetch lyrics from lyrics.ovh API (free, no key needed)
async function fetchLyrics(artist, title) {
  try {
    const response = await fetch(`https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`);
   
    if (!response.ok) {
      throw new Error('Lyrics not found');
    }
   
    const data = await response.json();
    return data.lyrics || null;
  } catch (error) {
    console.log('Lyrics fetch error:', error);
    return null;
  }
}
// Display lyrics
async function displayLyrics(song) {
  const lyricsSection = document.getElementById('lyrics-section');
  const lyricsText = document.getElementById('lyrics-text');
  const lyricsContainer = document.getElementById('lyrics-container');
 
  if (!song || !song.title || !song.artist?.name) {
    lyricsSection.style.display = 'none';
    return;
  }
 
  // Show section and loading state
  lyricsSection.style.display = 'block';
  lyricsText.className = 'loading';
  lyricsText.textContent = 'Loading lyrics...';
 
  // Update container background to match current gradient color
  if (lyricsContainer) {
    lyricsContainer.style.background = `rgba(${currentGradientColor.r}, ${currentGradientColor.g}, ${currentGradientColor.b}, 0.2)`;
  }
 
  // Fetch lyrics
  const lyrics = await fetchLyrics(song.artist.name, song.title);
 
  if (lyrics) {
    lyricsText.className = '';
    lyricsText.textContent = lyrics.trim();
  } else {
    lyricsText.className = 'loading';
    lyricsText.textContent = 'Lyrics not available for this song';
  }
}
// Hook into the playSong function to fetch lyrics
const originalPlaySongWithLyrics = window.playSong;
window.playSong = async function(song, fromPlaylist = false) {
  await originalPlaySongWithLyrics.call(this, song, fromPlaylist);
 
  // Fetch and display lyrics
  displayLyrics(song);
};
// Hide lyrics when player is hidden
const originalHidePlayer = window.hidePlayer;
window.hidePlayer = function() {
  originalHidePlayer.call(this);
 
  const lyricsSection = document.getElementById('lyrics-section');
  if (lyricsSection) {
    lyricsSection.style.display = 'none';
  }
};
    </script>
    <script>
const rightSidebar = document.getElementById("right-sidebar");
const nowPlayingSidebar = document.getElementById("now-playing-sidebar");
const nowPlayingCover = document.getElementById("now-playing-cover");
const nowPlayingTitle = document.getElementById("now-playing-title");
const nowPlayingArtist = document.getElementById("now-playing-artist");
const addCurrentBtn = document.getElementById("add-current-to-playlist");
let currentSong = null;
let currentPlaylist = null; // { name, index }
let queueFromPlaylist = false;
let currentAlbum = null;
let recentlyPlayedAlbums = JSON.parse(localStorage.getItem("recentlyPlayedAlbums") || "[]");
function saveRecentAlbum(album) {
  const albumToSave = {
    id: album.id,
    title: album.title,
    artist: album.artist,
    cover: album.cover,
    cover_medium: album.cover_medium
  };
  recentlyPlayedAlbums = recentlyPlayedAlbums.filter(a => a.id !== album.id);
  recentlyPlayedAlbums.push(albumToSave);
  if (recentlyPlayedAlbums.length > 20) recentlyPlayedAlbums.shift();
  localStorage.setItem("recentlyPlayedAlbums", JSON.stringify(recentlyPlayedAlbums));
  if (homePage.style.display === "block") loadHomeContent();
}
// ====================== DIALOGS ======================
function showInputDialog(title, message, defaultValue = '') {
  return new Promise((resolve) => {
    const modal = document.getElementById('input-modal');
    const titleEl = document.getElementById('input-modal-title');
    const messageEl = document.getElementById('input-modal-message');
    const inputEl = document.getElementById('input-modal-input');
    const okBtn = document.getElementById('input-modal-ok');
    const cancelBtn = document.getElementById('input-modal-cancel');
    titleEl.textContent = title;
    messageEl.textContent = message;
    inputEl.value = defaultValue;
    modal.classList.add('active');
    inputEl.focus();
    const cleanup = () => {
      modal.classList.remove('active');
      okBtn.onclick = cancelBtn.onclick = inputEl.onkeydown = null;
    };
    okBtn.onclick = () => { cleanup(); resolve(inputEl.value.trim() || null); };
    cancelBtn.onclick = () => { cleanup(); resolve(null); };
    inputEl.onkeydown = (e) => {
      if (e.key === 'Enter') okBtn.click();
      if (e.key === 'Escape') cancelBtn.click();
    };
  });
}
function showAlert(title, message) {
  return new Promise((resolve) => {
    const modal = document.getElementById('alert-modal');
    const titleEl = document.getElementById('alert-modal-title');
    const messageEl = document.getElementById('alert-modal-message');
    const okBtn = document.getElementById('alert-modal-ok');
    titleEl.textContent = title;
    messageEl.textContent = message;
    modal.classList.add('active');
    okBtn.onclick = () => {
      modal.classList.remove('active');
      okBtn.onclick = null;
      resolve();
    };
  });
}
function showConfirm(title, message) {
  return new Promise((resolve) => {
    const modal = document.getElementById('confirm-modal');
    const titleEl = document.getElementById('confirm-modal-title');
    const messageEl = document.getElementById('confirm-modal-message');
    const okBtn = document.getElementById('confirm-modal-ok');
    const cancelBtn = document.getElementById('confirm-modal-cancel');
    titleEl.textContent = title;
    messageEl.textContent = message;
    modal.classList.add('active');
    const cleanup = () => {
      modal.classList.remove('active');
      okBtn.onclick = cancelBtn.onclick = null;
    };
    okBtn.onclick = () => { cleanup(); resolve(true); };
    cancelBtn.onclick = () => { cleanup(); resolve(false); };
  });
}
function showPlaylistSelect(playlists) {
  return new Promise((resolve) => {
    const modal = document.getElementById('playlist-select-modal');
    const listEl = document.getElementById('playlist-select-list');
    const cancelBtn = document.getElementById('playlist-select-cancel');
    listEl.innerHTML = '';
    Object.keys(playlists).forEach(name => {
      const item = document.createElement('div');
      item.className = 'playlist-select-item';
      item.textContent = name;
      item.onclick = () => {
        modal.classList.remove('active');
        resolve(name);
      };
      listEl.appendChild(item);
    });
    modal.classList.add('active');
    cancelBtn.onclick = () => {
      modal.classList.remove('active');
      resolve(null);
    };
  });
}
// ====================== DOM ELEMENTS ======================
const premiumBtn = document.getElementById("premium-btn");
const premiumPopup = document.getElementById("premium-popup");
const profileBtn = document.getElementById("profile-btn");
const profilePopup = document.getElementById("profile-popup");
const profileName = document.getElementById("profile-name");
const changeNameBtn = document.getElementById("change-name");
const profileAvatar = document.getElementById("profile-avatar");
const changeAvatarBtn = document.getElementById("change-avatar-btn");
const uploadAvatar = document.getElementById("upload-avatar");
const bioInput = document.getElementById("bio-input");
const searchInput = document.getElementById("search");
const results = document.getElementById("results");
const player = document.getElementById("player");
const nowPlaying = document.getElementById("now-playing");
const sidebar = document.getElementById("sidebar");
const lyricsViewer = document.getElementById("lyrics-viewer");
const lyricsText = document.getElementById("lyrics-text");
const homePage = document.getElementById("home-page");
const searchPage = document.getElementById("search-page");
const homeNav = document.getElementById("home-nav");
const searchNav = document.getElementById("search-nav");
const welcome = document.getElementById("welcome");
const recentlyPlayedDiv = document.getElementById("recently-played");
const aiRecommendations = document.getElementById("ai-recommendations");
const recommendInput = document.getElementById("recommend-input");
const yourPlaylists = document.getElementById("your-playlists");
const popular = document.getElementById("popular");
const popularSection = document.getElementById("popular-section");
const searchResultsTitle = document.getElementById("search-results-title");
const uploadPlaylistCover = document.getElementById("upload-playlist-cover");
// New elements for YT player controls
const prevBtn = document.getElementById('prev-btn');
const playPauseBtn = document.getElementById('play-pause-btn');
const nextBtn = document.getElementById('next-btn');
const progressBar = document.getElementById('progress-bar');
const timeDisplay = document.getElementById('time-display');
// ====================== STATE ======================
let userName = localStorage.getItem("userName") || "User";
let userAvatar = localStorage.getItem("userAvatar") || "https://via.placeholder.com/80";
let userBio = localStorage.getItem("userBio") || "";
let recentlyPlayed = JSON.parse(localStorage.getItem("recentlyPlayed") || "[]");
let playlists = JSON.parse(localStorage.getItem("miniPlaylists") || "{}");
// ====================== LIKED ARTISTS (HEART SYSTEM) ======================
let likedArtists = JSON.parse(localStorage.getItem("likedArtists") || "{}");
// Format: { "Artist Name": { name, cover } }
function toggleLikeArtist(artistName, coverUrl) {
  if (likedArtists[artistName]) {
    delete likedArtists[artistName];
  } else {
    likedArtists[artistName] = {
      name: artistName,
      cover: coverUrl || 'https://via.placeholder.com/42'
    };
  }
  localStorage.setItem("likedArtists", JSON.stringify(likedArtists));
  renderLikedArtistsSidebar();
}
function renderLikedArtistsSidebar() {
  const sidebar = document.getElementById('sidebar');
  // Remove old Liked Artists section
  const existingHeader = sidebar.querySelector('.playlists-header[data-type="liked-artists"]');
  if (existingHeader) {
    let next = existingHeader.nextElementSibling;
    while (next && next.classList.contains('liked-artist-item')) {
      next.remove();
      next = existingHeader.nextElementSibling;
    }
    existingHeader.remove();
  }
  const likedList = Object.values(likedArtists);
  if (likedList.length === 0) return;
  // Add header
  const header = document.createElement('div');
  header.className = 'playlists-header';
  header.setAttribute('data-type', 'liked-artists');
  header.textContent = '♥️ Liked Artists';
  sidebar.appendChild(header);
  // Add artists
  likedList.forEach(artist => {
    const div = document.createElement('div');
    div.className = 'playlist-item liked-artist-item';
    div.innerHTML = `
      <img class="playlist-cover" src="${artist.cover}" alt="artist">
      <strong style="flex:1;">${artist.name}</strong>
      <span class="heart-btn liked" onclick="event.stopPropagation(); toggleLikeArtist('${artist.name}', '${artist.cover}')">♥️</span>
    `;
    div.onclick = () => loadArtistSongs(artist.name);
    sidebar.appendChild(div);
  });
}
// Helper: Load songs by artist
async function loadArtistSongs(artistName) {
  showSearch();
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';
  searchResultsTitle.textContent = `Songs by ${artistName}`;
  searchResultsTitle.style.display = 'block';
  results.innerHTML = '<p style="text-align:center;color:#888;padding:40px;">Loading songs...</p>';
  const songs = await itunesFetch(artistName, 30);
  results.innerHTML = '';
  if (!songs.length) {
    results.innerHTML = '<p style="text-align:center;color:#888;">No songs found.</p>';
    return;
  }
  const container = document.createElement('div');
  songs.forEach(song => {
    const div = document.createElement('div');
    div.className = 'song-card';
    const coverSrc = song.album?.cover_medium || 'https://via.placeholder.com/64';
    const isLiked = !!likedArtists[song.artist?.name];
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;flex:1;">
        <img class="cover" src="${coverSrc}" alt="cover">
        <div style="flex:1;">
          <strong>${song.title}</strong><br>
          <small style="color:#aaa;">
            ${song.artist?.name || 'Unknown'}
            <span class="heart-btn ${isLiked ? 'liked' : ''}"
                  onclick="event.stopPropagation(); toggleLikeArtist('${song.artist?.name || 'Unknown'}', '${coverSrc}')">
              ${isLiked ? '♥️' : '♡'}
            </span>
          </small>
        </div>
      </div>
    `;
    div.onclick = () => playSong(song);
    container.appendChild(div);
  });
  results.appendChild(container);
}
// ====================== UTILS ======================
function getTimeBasedGreeting() {
  const hour = new Date().getHours();
  if (hour >= 5 && hour < 12) return "Good morning";
  if (hour < 17) return "Good afternoon";
  if (hour < 22) return "Good evening";
  return "Good night";
}
function generateId() {
  return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
}
function ensurePlaylistIds() {
  let changed = false;
  for (const name in playlists) {
    if (!playlists[name].id) {
      playlists[name].id = generateId();
      changed = true;
    }
  }
  if (changed) savePlaylists();
}
function savePlaylists() {
  ensurePlaylistIds();
  localStorage.setItem("miniPlaylists", JSON.stringify(playlists));
}
// ====================== PROFILE ======================
function updateUserProfile() {
  userName = localStorage.getItem("userName") || "User";
  userAvatar = localStorage.getItem("userAvatar") || "https://via.placeholder.com/80";
  userBio = localStorage.getItem("userBio") || "";
  welcome.textContent = `${getTimeBasedGreeting()}, ${userName}!`;
  profileName.textContent = userName;
  profileAvatar.src = userAvatar;
  bioInput.value = userBio;
  if (userAvatar.includes("placeholder")) {
    profileBtn.textContent = userName.charAt(0).toUpperCase();
    profileBtn.style.background = "var(--accent)";
  } else {
    profileBtn.innerHTML = `<img src="${userAvatar}" style="width:100%;height:100%;border-radius:50%;">`;
  }
}
updateUserProfile();
bioInput.addEventListener('input', () => localStorage.setItem("userBio", bioInput.value));
changeAvatarBtn.onclick = () => uploadAvatar.click();
uploadAvatar.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    localStorage.setItem("userAvatar", ev.target.result);
    updateUserProfile();
  };
  reader.readAsDataURL(file);
});
changeNameBtn.onclick = async () => {
  const newName = await showInputDialog('Change Name', 'Enter your name:', userName);
  if (newName && newName.trim()) {
    localStorage.setItem("userName", newName.trim());
    updateUserProfile();
    profilePopup.style.display = "none";
  }
};
// Popups
premiumBtn.onclick = () => premiumPopup.style.display = "block";
window.closePremium = () => premiumPopup.style.display = "none";
profileBtn.onclick = () => {
  profilePopup.style.display = profilePopup.style.display === "block" ? "none" : "block";
};
document.addEventListener("click", (e) => {
  if (!profileBtn.contains(e.target) && !profilePopup.contains(e.target))
    profilePopup.style.display = "none";
  if (!premiumBtn.contains(e.target) && !premiumPopup.contains(e.target))
    premiumPopup.style.display = "none";
});
// ====================== ITUNES API ======================
async function itunesFetch(query, limit = 20) {
  const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=song&limit=${limit}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    return (data.results || []).map(track => ({
      id: track.trackId,
      title: track.trackName,
      preview: track.previewUrl,
      artist: {
        id: track.artistId,
        name: track.artistName
      },
      album: {
        cover_medium: track.artworkUrl100?.replace('100x100', '200x200') || track.artworkUrl100,
        cover_big: track.artworkUrl100?.replace('100x100', '600x600') || track.artworkUrl100
      }
    }));
  } catch (err) {
    console.error('iTunes API error:', err);
    return [];
  }
}
async function itunesAlbumFetch(query, limit = 4) {
  const url = `https://itunes.apple.com/search?term=${encodeURIComponent(query)}&media=music&entity=album&limit=${limit}`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    return (data.results || []).map(album => ({
      id: album.collectionId,
      title: album.collectionName,
      artist: {
        id: album.artistId,
        name: album.artistName
      },
      cover: album.artworkUrl100?.replace('100x100', '600x600') || album.artworkUrl100,
      cover_medium: album.artworkUrl100?.replace('100x100', '200x200') || album.artworkUrl100,
      trackCount: album.trackCount,
      releaseDate: album.releaseDate
    }));
  } catch (err) {
    console.error('iTunes Album API error:', err);
    return [];
  }
}
async function itunesAlbumTracksFetch(albumId) {
  const url = `https://itunes.apple.com/lookup?id=${albumId}&entity=song`;
  try {
    const res = await fetch(url);
    const data = await res.json();
    const tracks = (data.results || []).slice(1);
    return tracks.map(track => ({
      id: track.trackId,
      title: track.trackName,
      preview: track.previewUrl,
      trackNumber: track.trackNumber,
      artist: {
        id: track.artistId,
        name: track.artistName
      },
      album: {
        id: track.collectionId,
        name: track.collectionName,
        cover_medium: track.artworkUrl100?.replace('100x100', '200x200') || track.artworkUrl100,
        cover_big: track.artworkUrl100?.replace('100x100', '600x600') || track.artworkUrl100
      }
    }));
  } catch (err) {
    console.error('iTunes Album Tracks API error:', err);
    return [];
  }
}
// ====================== YOUTUBE INTEGRATION ======================
const API_KEY = 'AIzaSyDNd7dwB1rZEpJzpyRrVZQwSKHvnt3Q7vQ'; // Your fake key; replace with real
let ytPlayer;
let playerReady = false;
let progressInterval;
window.onYouTubeIframeAPIReady = function() {
  ytPlayer = new YT.Player('youtube-player', {
    height: '0',
    width: '0',
    playerVars: {
      'autoplay': 0,
      'controls': 0
    },
    events: {
      'onReady': onYtPlayerReady,
      'onStateChange': onYtStateChange
    }
  });
};
async function getVideoId(query) {
  const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=1&q=${encodeURIComponent(query)}&key=${API_KEY}`);
  if (!response.ok) {
    throw new Error('YouTube search failed');
  }
  const data = await response.json();
  if (data.items && data.items.length > 0) {
    return data.items[0].id.videoId;
  }
  throw new Error('No video found');
}
function onYtPlayerReady(event) {
  playerReady = true;
}
function onYtStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    clearInterval(progressInterval);
    if (queueFromPlaylist && currentPlaylist) {
      if (currentPlaylist.isAlbum && currentAlbum) {
        const next = currentPlaylist.index + 1;
        if (next < currentAlbum.tracks.length) {
          currentPlaylist.index = next;
          playSong(currentAlbum.tracks[next], true);
          return;
        }
      } else {
        const pl = playlists[currentPlaylist.name];
        const next = currentPlaylist.index + 1;
        if (next < pl.songs.length) {
          currentPlaylist.index = next;
          playSong(pl.songs[next], true);
          return;
        }
      }
    }
    queueFromPlaylist = false;
    currentPlaylist = null;
    setTimeout(hidePlayer, 800);
  }
  if (event.data === YT.PlayerState.PLAYING) {
    playPauseBtn.innerHTML = '&#10074;&#10074;'; // Pause icon
    updateProgress();
  }
  if (event.data === YT.PlayerState.PAUSED) {
    playPauseBtn.innerHTML = '&#9654;'; // Play icon
  }
}
function updateProgress() {
  clearInterval(progressInterval);
  progressInterval = setInterval(() => {
    if (ytPlayer && ytPlayer.getDuration) {
      const current = ytPlayer.getCurrentTime();
      const duration = ytPlayer.getDuration();
      if (duration > 0) {
        progressBar.value = (current / duration) * 100;
        timeDisplay.textContent = formatTime(current) + ' / ' + formatTime(duration);
      }
    }
  }, 500);
}
function formatTime(seconds) {
  const min = Math.floor(seconds / 60);
  const sec = Math.floor(seconds % 60);
  return min + ':' + (sec < 10 ? '0' + sec : sec);
}
// ====================== SEARCH & POPULAR ======================
let searchTimeout;
searchInput.addEventListener("input", () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  showSearch();
  results.innerHTML = "";
  searchResultsTitle.style.display = 'none';
  popularSection.style.display = q ? 'none' : 'block';
  if (!q) return;
  searchResultsTitle.style.display = 'block';
  showSkeletons(results, 12);
  searchTimeout = setTimeout(async () => {
    try {
      const [songs, albums] = await Promise.all([
        itunesFetch(q, 20),
        itunesAlbumFetch(q, 4)
      ]);
      results.innerHTML = "";
      if (!songs.length && !albums.length) {
        results.innerHTML = "<p style='color:#aaa;text-align:center;padding:40px;'>No results found.</p>";
        return;
      }
      if (albums.length) {
        const albumSection = document.createElement('div');
        albumSection.innerHTML = '<h3 style="margin:0 0 16px;font-size:1.2em;font-weight:600;color:#eee;">Albums</h3>';
        const albumGrid = document.createElement('div');
        albumGrid.className = 'grid-container';
        albumGrid.style.marginBottom = '32px';
        albums.forEach(album => {
          const div = document.createElement('div');
          div.className = 'grid-card';
          div.innerHTML = `
            <img class="grid-cover" src="${album.cover_medium}" alt="cover">
            <div>
              <div class="grid-title">${album.title}</div>
              <div class="grid-artist">${album.artist.name}</div>
            </div>
          `;
          div.onclick = () => loadAlbum(album);
          albumGrid.appendChild(div);
        });
        albumSection.appendChild(albumGrid);
        results.appendChild(albumSection);
      }
      if (songs.length) {
        const songSection = document.createElement('div');
        songSection.innerHTML = '<h3 style="margin:0 0 16px;font-size:1.2em;font-weight:600;color:#eee;">Songs</h3>';
        results.appendChild(songSection);
        renderSongs(songs, results);
      }
    } catch (err) {
      results.innerHTML = "<p style='color:#f66;text-align:center;'>Search failed.</p>";
    }
  }, 400);
});
async function loadPopular() {
  popular.innerHTML = "";
  showSkeletons(popular, 10);
  try {
    const songs = await itunesFetch('top songs 2026', 20);
    renderSongs(songs, popular);
  } catch {
    popular.innerHTML = "<p style='color:#f66;'>Failed to load popular songs.</p>";
  }
}
// AI Recommendations
let recommendTimeout;
recommendInput.addEventListener("input", () => {
  clearTimeout(recommendTimeout);
  const q = recommendInput.value.trim();
  aiRecommendations.innerHTML = "";
  if (!q) return;
  showSkeletons(aiRecommendations, 6);
  recommendTimeout = setTimeout(async () => {
    try {
      const songs = await itunesFetch(q, 12);
      if (!songs.length) throw new Error("No songs");
      const mainSong = songs[0];
      const similar = await itunesFetch(`${mainSong.artist.name} songs`, 12);
      aiRecommendations.innerHTML = `<p style='margin-bottom:12px;color:#aaa;'>Songs like <strong>${mainSong.title}</strong>:</p>`;
      renderSongs(similar, aiRecommendations);
    } catch {
      aiRecommendations.innerHTML = "<p style='color:#f66;'>Recommendation failed.</p>";
    }
  }, 600);
});
// ====================== RENDERING ======================
function showSkeletons(container, count) {
  container.innerHTML = "";
  for (let i = 0; i < count; i++) {
    const sk = document.createElement("div");
    sk.className = "skeleton";
    container.appendChild(sk);
  }
}
function renderSongs(songs, container) {
  songs.forEach(song => {
    const div = document.createElement("div");
    div.className = "song-card";
    const artistName = song.artist?.name || "Unknown Artist";
    const cover = song.album?.cover_medium || 'https://via.placeholder.com/64';
    const isLiked = !!likedArtists[artistName];
    div.innerHTML = `
      <div style="display:flex;align-items:center;gap:16px;flex:1;">
        <img class="cover" src="${cover}" alt="Cover">
        <div style="flex:1;">
          <strong>${song.title}</strong><br>
          <small style="color:#aaa;">
            ${artistName}
            <span class="heart-btn ${isLiked ? 'liked' : ''}"
                  onclick="event.stopPropagation(); toggleLikeArtist('${artistName}', '${cover}')">
              ${isLiked ? '♥️' : '♡'}
            </span>
          </small>
        </div>
      </div>
      <button class="add-btn">Add</button>
    `;
    div.querySelector('.add-btn').onclick = (e) => {
      e.stopPropagation();
      addSongToPlaylist(song);
    };
    div.onclick = () => playSong(song);
    container.appendChild(div);
  });
}
function renderGridCard(item, container, clickHandler) {
  const div = document.createElement('div');
  div.className = 'grid-card';
  const cover = item.album?.cover_medium || item.cover_medium || item.cover || 'https://via.placeholder.com/180?text=♪';
  const title = item.title || item.name || 'Untitled';
  const artist = item.artist?.name || '';
  div.innerHTML = `
    <img class="grid-cover" src="${cover}" alt="cover">
    <div>
      <div class="grid-title">${title}</div>
      ${artist ? `<div class="grid-artist">${artist}</div>` : ''}
    </div>
  `;
  div.onclick = () => clickHandler(item);
  container.appendChild(div);
}
// ====================== PLAYER ======================
async function playSong(song, fromPlaylist = false) {
  if (!song?.id) {
    await showAlert('Invalid Song', 'This song cannot be played.');
    return;
  }
  if (!song.album || !song.artist?.id) {
    try {
      const fresh = await itunesFetch(song.title + ' ' + song.artist?.name, 1);
      if (fresh[0]) song = fresh[0];
    } catch (e) { console.warn("Failed to refresh song data", e); }
  }
  currentSong = song;
  nowPlaying.textContent = `Now playing: ${song.title} — ${song.artist?.name || 'Unknown'}`;
  player.style.display = "block";
  const bigCover = song.album?.cover_big || song.album?.cover_medium || 'https://via.placeholder.com/240';
  nowPlayingCover.src = bigCover;
  nowPlayingTitle.textContent = song.title;
  nowPlayingArtist.textContent = song.artist?.name || 'Unknown Artist';
  rightSidebar.classList.remove("hidden");
  nowPlayingSidebar.style.display = "block";
  const songToSave = {
    id: song.id,
    title: song.title,
    preview: song.preview,
    artist: { id: song.artist?.id, name: song.artist?.name || "Unknown" },
    album: {
      cover_medium: song.album?.cover_medium || 'https://via.placeholder.com/64',
      cover_big: song.album?.cover_big || 'https://via.placeholder.com/240'
    },
    videoId: song.videoId // Save if found
  };
  recentlyPlayed = recentlyPlayed.filter(s => s.id !== song.id);
  recentlyPlayed.push(songToSave);
  if (recentlyPlayed.length > 20) recentlyPlayed.shift();
  localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed));
  if (homePage.style.display === "block") loadHomeContent();
  renderLikedArtistsSidebar();
  if (fromPlaylist && currentPlaylist) {
    queueFromPlaylist = true;
  } else {
    queueFromPlaylist = false;
    currentPlaylist = null;
  }
  // YouTube playback
  try {
    let videoId = song.videoId;
    if (!videoId) {
      const query = `${song.title} ${song.artist.name} official audio`;
      videoId = await getVideoId(query);
      song.videoId = videoId; // Cache
      songToSave.videoId = videoId; // Update saved
      localStorage.setItem("recentlyPlayed", JSON.stringify(recentlyPlayed)); // Resave
    }
    if (playerReady) {
      ytPlayer.loadVideoById(videoId);
      ytPlayer.playVideo();
    } else {
      // Wait for ready
      const waitReady = setInterval(() => {
        if (playerReady) {
          clearInterval(waitReady);
          ytPlayer.loadVideoById(videoId);
          ytPlayer.playVideo();
        }
      }, 100);
    }
  } catch (err) {
    await showAlert('Playback Error', 'No full song found on YouTube. Skipping.');
    // Optional fallback to iTunes preview (uncomment if wanted)
    // const fallbackAudio = new Audio(song.preview);
    // fallbackAudio.play();
    if (queueFromPlaylist && currentPlaylist) {
      playNext();
    } else {
      hidePlayer();
    }
  }
}
function startPlaylistPlayback(plName, startIdx = 0) {
  const pl = playlists[plName];
  if (!pl?.songs?.length) return;
  currentPlaylist = { name: plName, index: startIdx };
  queueFromPlaylist = true;
  playSong(pl.songs[startIdx], true);
}
function startAlbumPlayback(trackIndex) {
  if (!currentAlbum || !currentAlbum.tracks[trackIndex]) return;
  currentPlaylist = {
    name: `album_${currentAlbum.id}`,
    index: trackIndex,
    isAlbum: true
  };
  queueFromPlaylist = true;
  playSong(currentAlbum.tracks[trackIndex], true);
}
function playNext() {
  if (queueFromPlaylist && currentPlaylist) {
    if (currentPlaylist.isAlbum && currentAlbum) {
      const next = currentPlaylist.index + 1;
      if (next < currentAlbum.tracks.length) {
        currentPlaylist.index = next;
        playSong(currentAlbum.tracks[next], true);
        return;
      }
    } else {
      const pl = playlists[currentPlaylist.name];
      const next = currentPlaylist.index + 1;
      if (next < pl.songs.length) {
        currentPlaylist.index = next;
        playSong(pl.songs[next], true);
        return;
      }
    }
  }
  hidePlayer();
}
function playPrevious() {
  if (queueFromPlaylist && currentPlaylist && currentPlaylist.index > 0) {
    const prev = currentPlaylist.index - 1;
    currentPlaylist.index = prev;
    playSong(currentPlaylist.isAlbum ? currentAlbum.tracks[prev] : playlists[currentPlaylist.name].songs[prev], true);
  }
}
function hidePlayer() {
  nowPlayingSidebar.style.display = "none";
  player.style.display = "none";
  rightSidebar.classList.add("hidden");
  nowPlaying.textContent = "No song playing";
  clearInterval(progressInterval);
  progressBar.value = 0;
  timeDisplay.textContent = '0:00 / 0:00';
  playPauseBtn.innerHTML = '&#9654;';
  if (ytPlayer) ytPlayer.stopVideo();
}
addCurrentBtn.onclick = async () => {
  if (!currentSong) return;
  await addSongToPlaylist(currentSong);
};
// Custom controls events
prevBtn.onclick = playPrevious;
nextBtn.onclick = playNext;
playPauseBtn.onclick = () => {
  if (ytPlayer.getPlayerState() === YT.PlayerState.PLAYING) {
    ytPlayer.pauseVideo();
  } else {
    ytPlayer.playVideo();
  }
};
progressBar.oninput = () => {
  const percent = progressBar.value / 100;
  ytPlayer.seekTo(percent * ytPlayer.getDuration(), true);
};
// ====================== PLAYLISTS ======================
function renderSidebarPlaylists() {
  sidebar.querySelectorAll('.playlist-item').forEach(el => el.remove());
  const newBtn = document.createElement('div');
  newBtn.className = 'playlist-item new-playlist';
  newBtn.innerHTML = '<strong style="color:var(--accent);">+ Create Playlist</strong>';
  newBtn.onclick = async () => {
    const name = await showInputDialog('New Playlist', 'Enter playlist name:');
    if (!name?.trim()) return;
    if (playlists[name.trim()]) {
      await showAlert('Oops', 'A playlist with that name already exists.');
      return;
    }
    playlists[name.trim()] = { id: generateId(), songs: [], cover: null };
    savePlaylists();
    renderSidebarPlaylists();
    loadHomeContent();
  };
  sidebar.appendChild(newBtn);
  Object.keys(playlists).forEach(name => {
    const pl = playlists[name];
    const cover = pl.cover || 'https://via.placeholder.com/42x42.png?text=♪';
    const div = document.createElement('div');
    div.className = 'playlist-item';
    div.innerHTML = `
      <img class="playlist-cover" src="${cover}" alt="cover">
      <strong style="flex:1;">${name}</strong>
      <div class="playlist-actions">
        <button onclick="editPlaylist('${name}')">Edit</button>
        <button onclick="uploadPlaylistCoverFunc('${name}')">Cover</button>
      </div>
    `;
    div.addEventListener('click', (e) => {
      if (e.target.closest('.playlist-actions')) return;
      loadPlaylist(name);
    });
    sidebar.appendChild(div);
  });
}
async function editPlaylist(oldName) {
  const newName = await showInputDialog('Rename Playlist', 'New name:', oldName);
  if (!newName || newName === oldName) return;
  if (playlists[newName]) {
    await showAlert('Error', 'Playlist name already exists.');
    return;
  }
  playlists[newName] = playlists[oldName];
  delete playlists[oldName];
  savePlaylists();
  renderSidebarPlaylists();
  loadHomeContent();
}
async function sharePlaylist(id) {
  const url = `${location.origin}${location.pathname}?playlist=${id}`;
  try {
    await navigator.clipboard.writeText(url);
    await showAlert('Copied!', 'Playlist link copied to clipboard.');
  } catch {
    await showAlert('Share Link', url);
  }
}
async function deletePlaylist(name) {
  const ok = await showConfirm('Delete Playlist', `Delete "${name}" permanently?`);
  if (ok) {
    delete playlists[name];
    savePlaylists();
    renderSidebarPlaylists();
    loadHomeContent();
  }
}
function uploadPlaylistCoverFunc(name) {
  uploadPlaylistCover.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      playlists[name].cover = ev.target.result;
      savePlaylists();
      renderSidebarPlaylists();
      loadHomeContent();
      const bigCover = document.querySelector('.playlist-big-cover');
      if (bigCover) bigCover.src = ev.target.result;
    };
    reader.readAsDataURL(file);
  };
  uploadPlaylistCover.click();
}
async function addSongToPlaylist(song) {
  if (!Object.keys(playlists).length) {
    await showAlert('No Playlists', 'Create a playlist first!');
    return;
  }
  const plName = await showPlaylistSelect(playlists);
  if (!plName) return;
  const songToStore = {
    id: song.id,
    title: song.title,
    preview: song.preview,
    artist: { id: song.artist?.id, name: song.artist?.name || "Unknown" },
    album: {
      cover_medium: song.album?.cover_medium || 'https://via.placeholder.com/64',
      cover_big: song.album?.cover_big || 'https://via.placeholder.com/240'
    },
    videoId: song.videoId // Save if available
  };
  playlists[plName].songs.push(songToStore);
  savePlaylists();
  await showAlert('Added!', `Song added to "${plName}"`);
  loadHomeContent();
}
function loadPlaylist(name) {
  showSearch();
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';
  const pl = playlists[name];
  const cover = pl.cover || 'https://via.placeholder.com/280?text=♪';
  results.innerHTML = `
    <div class="playlist-view-header">
      <img class="playlist-big-cover" src="${cover}" alt="cover" style="cursor:pointer;" onclick="uploadPlaylistCoverFunc('${name}')">
      <h1 class="playlist-view-title">${name}</h1>
      <p class="playlist-view-song-count">${pl.songs.length} song${pl.songs.length !== 1 ? 's' : ''}</p>
    </div>
    <div class="playlist-header" style="justify-content:flex-end;margin:20px 0;">
      <button onclick="sharePlaylist('${pl.id}')">Share</button>
      <button onclick="deletePlaylist('${name}')">Delete</button>
    </div>
  `;
  const container = document.createElement('div');
  if (!pl.songs.length) {
    container.innerHTML = '<p style="text-align:center;color:#888;padding:60px;">This playlist is empty.<br>Add some songs!</p>';
  } else {
    pl.songs.forEach((song, i) => {
      const div = document.createElement('div');
      div.className = 'song-card';
      const artist = song.artist?.name || "Unknown";
      const coverSrc = song.album?.cover_medium || 'https://via.placeholder.com/64';
      const isLiked = !!likedArtists[artist];
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:16px;flex:1;">
          <img class="cover" src="${coverSrc}" alt="cover">
          <div style="flex:1;">
            <strong>${song.title}</strong><br>
            <small style="color:#aaa;">
              ${artist}
              <span class="heart-btn ${isLiked ? 'liked' : ''}"
                    onclick="event.stopPropagation(); toggleLikeArtist('${artist}', '${coverSrc}')">
                ${isLiked ? '♥️' : '♡'}
              </span>
            </small>
          </div>
        </div>
        <div style="color:#888;font-size:1.4em;">⋯</div>
      `;
      div.onclick = () => startPlaylistPlayback(name, i);
      container.appendChild(div);
    });
  }
  results.appendChild(container);
}
async function loadAlbum(album) {
  showSearch();
  searchInput.style.display = 'none';
  popularSection.style.display = 'none';
  searchResultsTitle.style.display = 'none';
  const cover = album.cover || 'https://via.placeholder.com/280?text=♪';
  results.innerHTML = `
    <div class="playlist-view-header">
      <img class="playlist-big-cover" src="${cover}" alt="cover">
      <h1 class="playlist-view-title">${album.title}</h1>
      <p class="playlist-view-song-count">${album.artist.name} • Album</p>
    </div>
  `;
  const loadingDiv = document.createElement('div');
  loadingDiv.innerHTML = '<p style="text-align:center;color:#888;padding:40px;">Loading tracks...</p>';
  results.appendChild(loadingDiv);
  const tracks = await itunesAlbumTracksFetch(album.id);
  loadingDiv.remove();
  currentAlbum = {
    id: album.id,
    title: album.title,
    tracks: tracks
  };
  const container = document.createElement('div');
  if (!tracks.length) {
    container.innerHTML = '<p style="text-align:center;color:#888;padding:60px;">No tracks found.</p>';
    currentAlbum = null;
  } else {
    tracks.forEach((song, i) => {
      const div = document.createElement('div');
      div.className = 'song-card';
      const coverSrc = song.album?.cover_medium || album.cover_medium;
      const isLiked = !!likedArtists[song.artist?.name];
      div.innerHTML = `
        <div style="display:flex;align-items:center;gap:16px;flex:1;">
          <img class="cover" src="${coverSrc}" alt="cover">
          <div style="flex:1;">
            <strong>${song.title}</strong><br>
            <small style="color:#aaa;">
              ${song.artist.name}
              <span class="heart-btn ${isLiked ? 'liked' : ''}"
                    onclick="event.stopPropagation(); toggleLikeArtist('${song.artist.name}', '${coverSrc}')">
                ${isLiked ? '♥️' : '♡'}
              </span>
            </small>
          </div>
        </div>
      `;
      div.onclick = () => startAlbumPlayback(i);
      container.appendChild(div);
    });
  }
  results.appendChild(container);
  saveRecentAlbum(album);
}
// ====================== HOME PAGE ======================
function loadHomeContent() {
recentlyPlayedDiv.innerHTML = '';
const recent = recentlyPlayed.slice(-8).reverse();
if (recent.length) {
  recent.forEach(s => {
    const fakeItem = {
      title: s.title,
      artist: { name: s.artist?.name || "Unknown Artist" },
      cover_medium: s.album?.cover_medium || 'https://via.placeholder.com/180?text=♪'
    };
    const div = document.createElement('div');
    div.className = 'grid-card';
    div.innerHTML = `
      <img class="grid-cover" src="${fakeItem.cover_medium}" alt="cover">
      <div class="text-container">
        <div class="grid-title">${fakeItem.title}</div>
        <div class="grid-artist">${fakeItem.artist.name}</div>
      </div>
    `;
    div.onclick = () => playSong(s);
    recentlyPlayedDiv.appendChild(div);
  });
} else {
  recentlyPlayedDiv.innerHTML = '<p style="color:#666;font-style:italic;">No recently played songs.</p>';
}
  yourPlaylists.innerHTML = '';
  const names = Object.keys(playlists);
  if (names.length) {
    const grid = document.createElement('div');
    grid.className = 'grid-container';
    names.forEach(name => {
      const pl = playlists[name];
      const fake = {
        title: name,
        cover: pl.cover || 'https://via.placeholder.com/180?text=♪'
      };
      renderGridCard(fake, grid, () => loadPlaylist(name));
    });
    yourPlaylists.appendChild(grid);
  } else {
    yourPlaylists.innerHTML = '<p style="color:#666;font-style:italic;">No playlists yet. Create one!</p>';
  }
  const existingAlbumSection = document.querySelector('[data-section="recent-albums"]');
  if (existingAlbumSection) existingAlbumSection.remove();
  const recentAlbums = recentlyPlayedAlbums.slice(-4).reverse();
  if (recentAlbums.length) {
    const albumSection = document.createElement('div');
    albumSection.className = 'section';
    albumSection.setAttribute('data-section', 'recent-albums');
    albumSection.innerHTML = '<h3>Recently Played Albums</h3>';
    const grid = document.createElement('div');
    grid.className = 'grid-container';
    recentAlbums.forEach(album => renderGridCard(album, grid, () => loadAlbum(album)));
    albumSection.appendChild(grid);
    const recentSection = recentlyPlayedDiv.parentElement;
    recentSection.parentElement.insertBefore(albumSection, recentSection.nextSibling);
  }
}
// ====================== NAVIGATION ======================
function showHome() {
  homePage.style.display = 'block';
  searchPage.style.display = 'none';
  homeNav.classList.add('active');
  searchNav.classList.remove('active');
  lyricsViewer.style.display = 'none';
  loadHomeContent();
  renderLikedArtistsSidebar();
}
function showSearch() {
  homePage.style.display = 'none';
  searchPage.style.display = 'block';
  homeNav.classList.remove('active');
  searchNav.classList.add('active');
  searchInput.style.display = 'block';
  searchInput.focus();
}
homeNav.onclick = showHome;
searchNav.onclick = showSearch;
// ====================== INIT ======================
ensurePlaylistIds();
renderSidebarPlaylists();
renderLikedArtistsSidebar();
showHome();
loadPopular();
// Load shared playlist from URL
const urlParams = new URLSearchParams(location.search);
const sharedId = urlParams.get('playlist');
if (sharedId) {
  setTimeout(() => {
    for (const name in playlists) {
      if (playlists[name].id === sharedId) {
        loadPlaylist(name);
        break;
      }
    }
  }, 600);
}
// Update greeting at midnight
setInterval(() => {
  if (new Date().getHours() === 0 && new Date().getMinutes() === 0) {
    updateUserProfile();
  }
}, 60000);
// Initial hide
if (!ytPlayer || ytPlayer.getPlayerState() !== YT.PlayerState.PLAYING) hidePlayer();
rightSidebar.classList.add("hidden");
     
    </script>
  </body>
</html>
