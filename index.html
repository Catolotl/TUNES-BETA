<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tunes — YouTube + iTunes + Lyrics</title>
  <style>
    :root{
      --bg: linear-gradient(180deg,#001414,#000);
      --surface: #232323;
      --card:#181818;
      --hover:#282828;
      --text:#fff;
      --muted:#b3b3b3;
      --accent:#32CD32;
      --border:#000;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,Helvetica,Arial,sans-serif;
      background:var(--bg);color:var(--text);height:100vh;display:flex;overflow:hidden;
    }
    header{
      position:fixed;top:0;left:0;right:0;height:70px;padding:12px 20px;
      display:flex;align-items:center;justify-content:space-between;z-index:30;
      background:transparent;border-bottom:5px solid var(--border);
    }
    header h2{margin:0;font-size:1.3rem; font-weight:700;
      background:linear-gradient(90deg,#fff,#ccc);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    }
    .header-center{display:flex;gap:8px;align-items:center;position:absolute;left:50%;transform:translateX(-50%)}
    .nav-item{padding:8px 12px;border-radius:18px;background:rgba(255,255,255,0.06);cursor:pointer}
    .nav-item.active{background:rgba(255,255,255,0.12)}
    #main-wrapper{display:flex;flex:1;margin-top:70px;width:100%}
    #sidebar{width:320px;background:var(--surface);padding:20px;border-right:5px solid var(--border);overflow:auto}
    #content{flex:1;padding:24px;overflow:auto}
    .search-bar{display:flex;gap:8px;margin-bottom:16px}
    input[type="search"]{flex:1;padding:12px;border-radius:12px;border:none;background:var(--card);color:var(--text)}
    button{background:var(--hover);color:var(--text);border:none;padding:10px 14px;border-radius:10px;cursor:pointer}
    .results{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:14px}
    .video-card{background:var(--card);padding:12px;border-radius:12px;cursor:pointer;display:flex;gap:12px;align-items:flex-start}
    .video-thumb{width:160px;aspect-ratio:16/9;object-fit:cover;border-radius:8px;flex-shrink:0}
    .video-meta{flex:1}
    .video-title{font-weight:600;margin-bottom:6px;font-size:0.95rem}
    .video-channel{color:var(--muted);font-size:0.85rem;margin-bottom:8px}
    .controls{display:flex;gap:8px;align-items:center;margin:12px 0}
    #player-area{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
    #video-player{width:100%;height:360px;border-radius:8px;border:none;background:#000}
    .meta-row{display:flex;gap:12px;align-items:center;margin-top:10px}
    .cover{width:72px;height:72px;border-radius:8px;object-fit:cover;flex-shrink:0}
    .now{flex:1}
    .muted{color:var(--muted)}
    #lyrics-box{white-space:pre-wrap;color:#eaeaea;max-height:260px;overflow:auto;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px}
    footer{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);background:transparent;z-index:40}
    .small{font-size:0.85rem;color:var(--muted)}
    @media(max-width:900px){
      #sidebar{display:none}
      .video-thumb{width:120px}
      #video-player{height:220px}
    }
  </style>
</head>
<body>
  <header>
    <h2>Tunes</h2>
    <div class="header-center">
      <div id="home-nav" class="nav-item active">Home</div>
      <div id="search-nav" class="nav-item">Search</div>
      <div id="video-nav" class="nav-item">Videos</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center">
      <div id="profile-btn" class="nav-item">?</div>
    </div>
  </header>

  <div id="main-wrapper">
    <aside id="sidebar">
      <div style="font-weight:700;margin-bottom:12px">Your Library</div>
      <div style="margin-bottom:8px;color:var(--muted)">Recently played</div>
      <div id="recent-list" style="display:flex;flex-direction:column;gap:8px"></div>
      <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">
      <div style="font-weight:700;margin-bottom:8px">Now</div>
      <div id="now-summary" class="muted">Nothing playing</div>
    </aside>

    <main id="content">
      <!-- Search area -->
      <div id="search-area">
        <div class="search-bar">
          <input id="q" type="search" placeholder="Search YouTube for songs, artists, albums..." />
          <button id="do-search">Search</button>
        </div>

        <div id="results" class="results"></div>
      </div>

      <!-- Player area -->
      <div id="player-area" style="margin-top:22px;display:none">
        <div id="video-player-wrapper">
          <div id="video-player-placeholder" style="display:block">
            <iframe id="video-player" src="" allow="autoplay; encrypted-media" allowfullscreen></iframe>
          </div>
        </div>

        <div class="controls">
          <button id="play-btn">Play</button>
          <button id="pause-btn">Pause</button>
          <button id="stop-btn">Stop</button>
          <div id="time-label" class="small muted">00:00 / 00:00</div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <button id="lyrics-btn">Show Lyrics</button>
            <button id="art-btn">iTunes Cover</button>
          </div>
        </div>

        <div class="meta-row">
          <img id="now-cover" class="cover" src="https://via.placeholder.com/72" alt="cover">
          <div class="now">
            <div id="now-title" style="font-weight:700">—</div>
            <div id="now-channel" class="muted">—</div>
          </div>
        </div>

        <div style="margin-top:12px;">
          <div id="lyrics-box" style="display:none"></div>
        </div>
      </div>
    </main>
  </div>

  <footer></footer>

  <script>
    // IMPORTANT: Replace with your own YouTube Data API key for full functionality.
    // You can restrict the key to your site for safety.
    const YOUTUBE_API_KEY = 'AIzaSyDNd7dwB1rZEpJzpyRrVZQwSKHvnt3Q7vQ';

    // State
    let searchTimeout = null;
    let lastResults = [];
    let player = null;             // YT.Player instance (IFrame API)
    let currentVideo = null;       // { videoId, title, channel, thumbnail }
    let recentlyPlayed = JSON.parse(localStorage.getItem('recentlyPlayed') || '[]');

    // DOM
    const qInput = document.getElementById('q');
    const doSearchBtn = document.getElementById('do-search');
    const resultsEl = document.getElementById('results');
    const playerArea = document.getElementById('player-area');
    const playBtn = document.getElementById('play-btn');
    const pauseBtn = document.getElementById('pause-btn');
    const stopBtn = document.getElementById('stop-btn');
    const nowTitle = document.getElementById('now-title');
    const nowChannel = document.getElementById('now-channel');
    const nowCover = document.getElementById('now-cover');
    const timeLabel = document.getElementById('time-label');
    const lyricsBtn = document.getElementById('lyrics-btn');
    const artBtn = document.getElementById('art-btn');
    const lyricsBox = document.getElementById('lyrics-box');
    const recentList = document.getElementById('recent-list');
    const nowSummary = document.getElementById('now-summary');

    // Utilities
    function formatISODuration(iso) {
      // Convert ISO 8601 duration (e.g. PT3M45S) to mm:ss or hh:mm:ss
      const match = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
      if (!match) return '0:00';
      const h = parseInt(match[1]||0,10);
      const m = parseInt(match[2]||0,10);
      const s = parseInt(match[3]||0,10);
      const parts = [];
      if (h) parts.push(String(h).padStart(2,'0'));
      parts.push(String(m).padStart(2,'0'));
      parts.push(String(s).padStart(2,'0'));
      return parts.join(':');
    }

    function saveRecentlyPlayed(video) {
      // video: { videoId, title, channel, thumbnail, artwork }
      const exists = recentlyPlayed.find(v => v.videoId === video.videoId);
      if (exists) {
        // move to end
        recentlyPlayed = recentlyPlayed.filter(v => v.videoId !== video.videoId);
      }
      recentlyPlayed.push({...video, playedAt: Date.now()});
      if (recentlyPlayed.length > 24) recentlyPlayed.shift();
      localStorage.setItem('recentlyPlayed', JSON.stringify(recentlyPlayed));
      renderRecent();
    }

    function renderRecent() {
      recentList.innerHTML = '';
      recentlyPlayed.slice().reverse().forEach(item => {
        const d = document.createElement('div');
        d.style.display = 'flex';
        d.style.alignItems = 'center';
        d.style.gap = '8px';
        d.style.cursor = 'pointer';
        d.onclick = () => playVideoById(item.videoId, item);
        d.innerHTML = `
          <img src="${item.thumbnail || item.artwork || 'https://via.placeholder.com/56'}" style="width:56px;height:56px;border-radius:6px;object-fit:cover">
          <div style="flex:1">
            <div style="font-size:0.95rem;font-weight:600">${item.title}</div>
            <div style="font-size:0.85rem;color:var(--muted)">${item.channel || item.artist || ''}</div>
          </div>
        `;
        recentList.appendChild(d);
      });
      nowSummary.textContent = currentVideo ? `${currentVideo.title} — ${currentVideo.channel}` : 'Nothing playing';
    }

    // YouTube search + details
    async function ytSearch(query, maxResults = 12) {
      if (!YOUTUBE_API_KEY || YOUTUBE_API_KEY === 'REPLACE_WITH_YOUR_KEY') {
        resultsEl.innerHTML = `<div style="padding:20px;color:#f88">Missing YouTube API key. Put your key in the YOUTUBE_API_KEY constant to enable search.</div>`;
        return [];
      }
      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&videoCategoryId=10&maxResults=${maxResults}&q=${encodeURIComponent(query)}&key=${YOUTUBE_API_KEY}`;
      const res = await fetch(url);
      const json = await res.json();
      if (!json.items) return [];
      const ids = json.items.map(i => i.id.videoId).join(',');
      // fetch duration & full thumbnails
      const detailsUrl = `https://www.googleapis.com/youtube/v3/videos?part=contentDetails,snippet&id=${ids}&key=${YOUTUBE_API_KEY}`;
      const detRes = await fetch(detailsUrl);
      const detJson = await detRes.json();
      const map = {};
      (detJson.items || []).forEach(it => {
        map[it.id] = it;
      });
      return json.items.map(item => {
        const id = item.id.videoId;
        const detail = map[id];
        return {
          videoId: id,
          title: item.snippet.title,
          channel: item.snippet.channelTitle,
          thumbnail: (detail && detail.snippet && (detail.snippet.thumbnails.maxres || detail.snippet.thumbnails.high || detail.snippet.thumbnails.medium)) ?
             (detail.snippet.thumbnails.maxres?.url || detail.snippet.thumbnails.high?.url || detail.snippet.thumbnails.medium?.url) :
             (item.snippet.thumbnails.medium && item.snippet.thumbnails.medium.url),
          duration: detail ? formatISODuration(detail.contentDetails.duration) : null
        };
      });
    }

    // Play using IFrame API (create or use existing player)
    function ensureYTPlayer(videoId) {
      // If player exists and same iframe, load; otherwise create.
      if (!player) {
        // we will rely on the iframe element and the IFrame API global YT
        // If YT is not ready yet, queue load once ready
        if (window.YT && window.YT.Player) {
          player = new YT.Player('video-player', {
            height: '360',
            width: '100%',
            videoId: videoId,
            playerVars: { autoplay: 1, controls: 1, modestbranding: 1 },
            events: {
              onReady: (e) => {
                e.target.playVideo();
                startTimeUpdater();
              },
              onStateChange: onPlayerStateChange
            }
          });
        } else {
          // create a temporary iframe (the API script will replace on load)
          const iframe = document.getElementById('video-player');
          iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&controls=1&modestbranding=1`;
          // When API loads, it will create player; for now we can poll
          const poll = setInterval(() => {
            if (window.YT && window.YT.Player) {
              clearInterval(poll);
              player = new YT.Player('video-player', {
                height: '360', width: '100%', videoId: videoId,
                playerVars: { autoplay: 1, controls: 1, modestbranding: 1 },
                events: { onReady: (e)=>{e.target.playVideo(); startTimeUpdater();}, onStateChange: onPlayerStateChange }
              });
            }
          }, 300);
        }
      } else {
        try {
          player.loadVideoById(videoId);
        } catch (e) {
          // fallback: set iframe src
          document.getElementById('video-player').src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&autoplay=1&controls=1&modestbranding=1`;
          // recreate player when API available if needed
        }
      }
    }

    function playVideoById(videoId, meta = null) {
      currentVideo = meta || { videoId };
      playerArea.style.display = 'block';
      nowTitle.textContent = currentVideo.title || 'Loading...';
      nowChannel.textContent = currentVideo.channel || '';
      nowCover.src = currentVideo.thumbnail || 'https://via.placeholder.com/72';
      saveRecentlyPlayed({...currentVideo});
      ensureYTPlayer(videoId);
    }

    // Player controls
    playBtn.onclick = () => {
      if (player && player.playVideo) player.playVideo();
    };
    pauseBtn.onclick = () => {
      if (player && player.pauseVideo) player.pauseVideo();
    };
    stopBtn.onclick = () => {
      if (player && player.stopVideo) player.stopVideo();
      timeLabel.textContent = '00:00 / 00:00';
    };

    // Player state updates
    function onPlayerStateChange(e) {
      // YT.PlayerState
      // -1 unstarted, 0 ended, 1 playing, 2 paused, 3 buffering, 5 cued
      if (e.data === 0) {
        // ended
      }
    }

    // Live time updater
    let timeUpdater = null;
    function startTimeUpdater() {
      if (!player || !player.getCurrentTime) return;
      if (timeUpdater) clearInterval(timeUpdater);
      timeUpdater = setInterval(() => {
        try {
          const current = Math.floor(player.getCurrentTime());
          const duration = Math.floor(player.getDuration()) || 0;
          const fmt = (s) => {
            const hh = Math.floor(s/3600); const mm = Math.floor((s%3600)/60); const ss = s%60;
            if (hh) return `${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
            return `${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
          };
          timeLabel.textContent = `${fmt(current)} / ${fmt(duration)}`;
        } catch (err) {}
      }, 700);
    }

    // Quick parse for artist/title from common "Artist - Title" or "Title - Artist"
    function guessArtistTitle(fullTitle, channel) {
      // try "Artist - Title" or "Title - Artist"
      const parts = fullTitle.split(' - ');
      if (parts.length >= 2) {
        // guess which is artist by checking channel inclusion
        if (channel && (fullTitle.toLowerCase().includes(channel.toLowerCase()) || channel.toLowerCase().includes(parts[0].toLowerCase()))) {
          return { artist: parts[0].trim(), title: parts.slice(1).join(' - ').trim() };
        }
        // else assume first is artist
        return { artist: parts[0].trim(), title: parts.slice(1).join(' - ').trim() };
      }
      // fallback: use channel as artist and fullTitle as title
      return { artist: channel || '', title: fullTitle };
    }

    // iTunes artwork lookup (fallback)
    async function fetchITunesArtwork(title, artist) {
      try {
        const q = encodeURIComponent(`${title} ${artist || ''}`);
        const url = `https://itunes.apple.com/search?term=${q}&entity=song&limit=1`;
        const res = await fetch(url);
        const j = await res.json();
        if (j.results && j.results.length) {
          const art = j.results[0].artworkUrl100 || j.results[0].artworkUrl60;
          if (art) return art.replace(/100x100bb/, '600x600bb');
        }
      } catch (e) { /* ignore */ }
      return null;
    }

    // Lyrics lookup using lyrics.ovh (simple demo, no license guarantees)
    async function fetchLyrics(artist, title) {
      try {
        const url = `https://api.lyrics.ovh/v1/${encodeURIComponent(artist)}/${encodeURIComponent(title)}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('No lyrics');
        const j = await res.json();
        return j.lyrics || null;
      } catch (e) { return null; }
    }

    // Render results
    function renderResults(items) {
      resultsEl.innerHTML = '';
      if (!items.length) {
        resultsEl.innerHTML = '<div style="padding:20px;color:var(--muted)">No results</div>';
        return;
      }
      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.innerHTML = `
          <img class="video-thumb" src="${it.thumbnail || 'https://via.placeholder.com/320x180'}" alt="thumb">
          <div class="video-meta">
            <div class="video-title">${it.title}</div>
            <div class="video-channel">${it.channel} ${it.duration ? ' • ' + it.duration : ''}</div>
            <div style="margin-top:8px">
              <button data-id="${it.videoId}" class="btn-play">Play</button>
              <button data-id="${it.videoId}" class="btn-art">Cover</button>
              <button data-id="${it.videoId}" class="btn-lyrics">Lyrics</button>
            </div>
          </div>
        `;
        // handlers
        card.querySelector('.btn-play').onclick = () => playVideoById(it.videoId, it);
        card.querySelector('.btn-art').onclick = async () => {
          const guess = guessArtistTitle(it.title, it.channel);
          const art = await fetchITunesArtwork(guess.title, guess.artist);
          alert(art ? `iTunes cover found: ${art}` : 'No iTunes cover found');
        };
        card.querySelector('.btn-lyrics').onclick = async () => {
          const guess = guessArtistTitle(it.title, it.channel);
          const lyrics = await fetchLyrics(guess.artist, guess.title);
          lyricsBox.style.display = lyrics ? 'block' : 'none';
          lyricsBox.textContent = lyrics || 'Lyrics not found.';
          if (lyrics) window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };
        resultsEl.appendChild(card);
      });
    }

    // Search flow (debounced)
    async function doSearch(q) {
      if (!q || !q.trim()) {
        resultsEl.innerHTML = '';
        return;
      }
      resultsEl.innerHTML = '<div style="padding:24px;color:var(--muted)">Searching...</div>';
      const items = await ytSearch(q, 18);
      lastResults = items;
      renderResults(items);
    }

    qInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => doSearch(qInput.value.trim()), 450);
    });
    doSearchBtn.onclick = () => doSearch(qInput.value.trim());

    // Lyrics / art quick buttons when a video is loaded
    lyricsBtn.onclick = async () => {
      if (!currentVideo) return;
      const guess = guessArtistTitle(currentVideo.title, currentVideo.channel);
      const l = await fetchLyrics(guess.artist, guess.title);
      lyricsBox.style.display = l ? 'block' : 'none';
      lyricsBox.textContent = l || 'Lyrics not found.';
    };
    artBtn.onclick = async () => {
      if (!currentVideo) return;
      const guess = guessArtistTitle(currentVideo.title, currentVideo.channel);
      const art = await fetchITunesArtwork(guess.title, guess.artist);
      if (art) {
        nowCover.src = art;
        alert('iTunes artwork applied to now playing.');
        // update recently played entry
        saveRecentlyPlayed({...currentVideo, artwork: art, thumbnail: nowCover.src});
      } else {
        alert('No iTunes artwork found.');
      }
    };

    // Keyboard toggle: space to pause/play
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && (document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA')) {
        e.preventDefault();
        if (player && typeof player.getPlayerState === 'function') {
          const state = player.getPlayerState();
          if (state === 1) player.pauseVideo();
          else if (state === 2 || state === -1 || state === 5) player.playVideo();
        }
      }
    });

    // Init IFrame API
    function loadYouTubeIframeAPI() {
      return new Promise((resolve) => {
        if (window.YT && window.YT.Player) return resolve();
        const tag = document.createElement('script');
        tag.src = "https://www.youtube.com/iframe_api";
        const firstScriptTag = document.getElementsByTagName('script')[0];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
        window.onYouTubeIframeAPIReady = () => resolve();
      });
    }

    // Start
    (async function init(){
      renderRecent();
      await loadYouTubeIframeAPI();
      // optional: pre-populate with a trending search or welcome
      const welcomeQuery = 'top chart music 2025';
      // doSearch(welcomeQuery);
    })();
  </script>
</body>
</html>
